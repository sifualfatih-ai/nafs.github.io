<!doctype html>
<html lang="id">
<head>
  
<link rel="icon" href="nafsweb.ico" />
<link rel="apple-touch-icon" href="nafsweb.ico" />
<link rel="shortcut icon" href="/nafsweb.ico" type="image/ico" />
  
  
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NafsFlow‑style Builder — Web3 Simulator (No NFT/Crypto)</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7', // ungu
              600: '#9333ea', // ungu tua
              700: '#7e22ce',
              800: '#6b21a8',
              900: '#581c87'
            }
          }
        }
      }
    }
  </script>
  <style>
    pre { white-space: pre-wrap; word-wrap: break-word; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-brand-50 to-white text-gray-900">
  <div class="mx-auto max-w-6xl p-4 sm:p-6">
    <header class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-brand-700">NafsFlow‑style Builder — Web3 Simulator</h1>
        <p class="text-sm text-gray-600">Belajar konsep Web3 tanpa NFT & cryptocurrency. Fokus: <b>DID & VC</b>, <b>traceability</b>, <b>penyimpanan terdesentralisasi</b>, <b>agen AI sederhana</b>, integrasi multi‑platform. Versi ini menyertakan <b>Adaptor "lebih nyata" opsional</b> untuk DID method dan IPFS.</p>
      </div>
      <div class="flex flex-wrap gap-2 text-xs">
        <span class="rounded-full border border-brand-200 bg-brand-50 px-2.5 py-1 text-brand-700">Beginner‑friendly</span>
        <span class="rounded-full border border-brand-200 bg-white px-2.5 py-1">Works offline</span>
      </div>
    </header>

    <!-- Adapters / Real-world Options -->
    <section class="mb-6 rounded-2xl border border-brand-200 bg-white p-5 shadow-sm">
      <div class="mb-3 flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-brand-700">Adaptor "Lebih Nyata" (Opsional)</h2>
          <p class="text-sm text-gray-600">Gunakan jika ingin menyentuh standar/layanan nyata. Tanpa adaptor, simulator tetap berfungsi lokal.</p>
        </div>
      </div>
      <div class="grid gap-4 md:grid-cols-2">
        <!-- DID Method -->
        <div class="rounded-xl border border-brand-100 p-3">
          <div class="mb-1 font-medium">DID Method</div>
          <p class="text-sm text-gray-600">Pilih generator DID: <b>did:example</b> (P‑256, demo) atau <b>did:key</b> (Ed25519, nyata & tanpa registry).</p>
          <div class="mt-2 flex flex-wrap gap-2 text-sm">
            <label class="inline-flex items-center gap-2"><input type="radio" name="didMethod" value="example" checked class="accent-brand-600"/> did:example (demo)</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="didMethod" value="didkey" class="accent-brand-600"/> did:key (Ed25519)</label>
          </div>
          <p class="mt-2 text-xs text-gray-500">Catatan: penandatanganan akan memakai <code>ES256</code> (P‑256) atau <code>EdDSA</code> (Ed25519) sesuai pilihan & dukungan browser.</p>
        </div>
        <!-- IPFS (web3.storage) -->
        <div class="rounded-xl border border-brand-100 p-3">
          <div class="mb-1 font-medium">IPFS (via web3.storage)</div>
          <p class="text-sm text-gray-600">Masukkan token API <a href="https://web3.storage/" target="_blank" class="text-brand-700 underline">web3.storage</a> untuk menyimpan konten beneran ke IPFS/Filecoin.</p>
          <input id="w3Token" type="password" placeholder="Bearer token" class="mt-2 w-full rounded-xl border border-gray-200 p-2 text-sm outline-none focus:ring-2 focus:ring-brand-200" />
          <p class="mt-2 text-xs text-gray-500">Jika kosong, modul storage tetap berjalan dalam mode <i>simulasi CID</i> (hash lokal).</p>
        </div>
      </div>
    </section>

    <!-- Grid 1: Identity & Storage -->
    <div class="mb-6 grid grid-cols-1 gap-6 lg:grid-cols-2">
      <!-- DID & VC -->
      <section class="rounded-2xl border border-brand-200 bg-white p-5 shadow-sm">
        <div class="mb-3 flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold text-brand-700">Identitas Digital (DID) & Verifiable Credential</h2>
            <p class="text-sm text-gray-600">Buat DID, terbitkan & verifikasi VC (JWS). Pilihan method mengikuti pengaturan adaptor.</p>
          </div>
          <button id="btnGenDID" class="rounded-xl bg-brand-600 px-3 py-2 text-sm font-medium text-white hover:bg-brand-700">Generate DID</button>
        </div>
        <div class="space-y-3">
          <div class="rounded-xl border border-gray-200 bg-brand-50/50 p-3 text-sm">
            <div class="text-gray-700">DID</div>
            <div id="didValue" class="truncate font-mono text-xs text-gray-900">— belum dibuat —</div>
            <div class="mt-1 text-xs text-gray-500">Algoritma: <span id="algoLabel">P‑256 (ES256)</span> • Semua proses lokal di browser</div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="btnIssueVC" class="rounded-xl border border-brand-200 bg-white px-3 py-2 text-sm hover:bg-brand-50 disabled:opacity-60" disabled>Issue VC</button>
            <button id="btnVerifyVC" class="rounded-xl border border-brand-200 bg-white px-3 py-2 text-sm hover:bg-brand-50 disabled:opacity-60" disabled>Verify VC</button>
          </div>

          <div>
            <div class="text-sm font-medium text-gray-700">Credential (payload)</div>
            <pre class="mt-1 max-h-56 overflow-auto rounded-xl bg-gray-950 p-3 text-xs text-gray-100"><code id="vcPayload">—</code></pre>
          </div>
          <div>
            <div class="text-sm font-medium text-gray-700">JWS (signed)</div>
            <pre class="mt-1 max-h-56 overflow-auto rounded-xl bg-gray-950 p-3 text-xs text-gray-100"><code id="vcJws">—</code></pre>
          </div>

          <div id="verifyBadge" class="hidden rounded-xl border p-3 text-sm"></div>
          <p class="text-xs text-gray-500">Ini simulasi edukasi dengan opsi adaptor nyata. Periksa kompatibilitas browser untuk Ed25519.</p>
        </div>
      </section>

      <!-- Decentralized Storage -->
      <section class="rounded-2xl border border-brand-200 bg-white p-5 shadow-sm">
        <div class="mb-3 flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold text-brand-700">Penyimpanan Terdesentralisasi</h2>
            <p class="text-sm text-gray-600">Simulasi CID (hash lokal) atau unggah beneran ke IPFS jika token web3.storage tersedia.</p>
          </div>
          <div class="flex gap-2">
            <button id="btnStoreText" class="rounded-xl bg-brand-600 px-3 py-2 text-sm font-medium text-white hover:bg-brand-700">Store as CID</button>
            <button id="btnUploadIPFS" class="rounded-xl border border-brand-200 bg-white px-3 py-2 text-sm hover:bg-brand-50">Upload to IPFS</button>
          </div>
        </div>
        <label class="mb-2 block text-sm font-medium text-gray-700">
          <span class="mb-1 block">Konten</span>
          <textarea id="fileText" rows="6" class="w-full rounded-xl border border-gray-200 bg-white p-3 text-sm outline-none focus:ring-2 focus:ring-brand-200">Example: Temperature log 18-22°C, humidity 55%.</textarea>
        </label>
        <div class="rounded-xl border border-gray-200 bg-brand-50/50 p-3 text-sm">
          <div class="text-gray-700">CID</div>
          <div id="cidValue" class="font-mono text-xs">— belum ada —</div>
        </div>
        <p class="mt-2 text-xs text-gray-500">IPFS: memerlukan token <code>web3.storage</code>. Jika gagal (CORS/Jaringan), tetap pakai mode simulasi.</p>
      </section>
    </div>

    <!-- Supply Chain -->
    <section class="rounded-2xl border border-brand-200 bg-white p-5 shadow-sm">
      <div class="mb-3 flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-brand-700">Supply Chain Traceability</h2>
          <p class="text-sm text-gray-600">Tambahkan event ke ledger berantai-hash lokal.</p>
        </div>
        <button id="btnAppendEvent" class="rounded-xl bg-brand-600 px-3 py-2 text-sm font-medium text-white hover:bg-brand-700">Append Event</button>
      </div>
      <div class="grid gap-4 lg:grid-cols-[1fr_2fr]">
        <div class="space-y-3">
          <label class="mb-2 block text-sm font-medium text-gray-700">
            <span class="mb-1 block">Catatan Event</span>
            <textarea id="eventNote" rows="4" class="w-full rounded-xl border border-gray-200 bg-white p-3 text-sm outline-none focus:ring-2 focus:ring-brand-200">Harvested raw cacao beans in West Java</textarea>
          </label>
          <div class="rounded-xl border border-gray-200 bg-brand-50/50 p-3 text-sm">
            <div class="text-gray-700">Pointer Storage</div>
            <div id="storagePtr" class="font-mono text-xs">— belum ada —</div>
          </div>
          <p class="text-xs text-gray-500">Setiap block menyimpan hash block sebelumnya. Perubahan data lama akan merusak rantai hash.</p>
        </div>
        <div class="overflow-auto rounded-xl border border-gray-200">
          <table class="w-full text-left text-sm">
            <thead class="bg-brand-50/70">
              <tr>
                <th class="px-3 py-2">#</th>
                <th class="px-3 py-2">Timestamp</th>
                <th class="px-3 py-2">Note</th>
                <th class="px-3 py-2">Prev</th>
                <th class="px-3 py-2">Hash</th>
              </tr>
            </thead>
            <tbody id="chainBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Grid 2: Agent & Multi-platform + PREVIEW MINI -->
    <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-3">
      <!-- AI Agents + Web3 -->
      <section class="rounded-2xl border border-brand-200 bg-white p-5 shadow-sm lg:col-span-2">
        <div class="mb-3 flex items-start justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold text-brand-700">AI Agents + Web3 (Simulasi)</h2>
            <p class="text-sm text-gray-600">Agen rule‑based membaca status & memberi saran; bila ada DID, buat attestasi bertanda tangan.</p>
          </div>
          <button id="btnRunAgent" class="rounded-xl bg-brand-600 px-3 py-2 text-sm font-medium text-white hover:bg-brand-700">Run Agent</button>
        </div>
        <div id="agentLog" class="space-y-3 text-sm">
          <div class="text-gray-500">Belum ada keluaran agen. Klik <b>Run Agent</b>.</div>
        </div>
      </section>

      <!-- MINI PREVIEW PANEL -->
      <aside class="rounded-2xl border border-brand-200 bg-white p-5 shadow-sm">
        <div class="mb-3 flex items-center justify-between">
          <h2 class="text-lg font-semibold text-brand-700">Preview Mini</h2>
          <button id="btnExport" class="rounded-xl border border-brand-200 bg-white px-3 py-1.5 text-sm hover:bg-brand-50">Export JSON</button>
        </div>
        <div class="space-y-3 text-sm">
          <div class="rounded-xl border border-brand-100 p-3">
            <div class="text-xs text-gray-500">DID</div>
            <div id="previewDID" class="truncate font-mono text-xs">—</div>
          </div>
          <div class="rounded-xl border border-brand-100 p-3">
            <div class="text-xs text-gray-500">VC</div>
            <div id="previewVC" class="text-xs">—</div>
          </div>
          <div class="rounded-xl border border-brand-100 p-3">
            <div class="text-xs text-gray-500">Storage</div>
            <div id="previewCID" class="font-mono text-xs">—</div>
          </div>
          <div class="rounded-xl border border-brand-100 p-3">
            <div class="text-xs text-gray-500">Ledger</div>
            <div id="previewLedger" class="text-xs">Genesis only</div>
          </div>
        </div>
      </aside>
    </div>

    <!-- Multi‑Platform Integration -->
    <section class="mt-6 rounded-2xl border border-brand-200 bg-white p-5 shadow-sm">
      <div class="mb-3 flex items-start justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-brand-700">Integrasi Multi‑Platform (Konsep)</h2>
          <p class="text-sm text-gray-600">Contoh pola tanpa token kripto. Anda bisa <span class="font-semibold">Export JSON</span> untuk dibagikan/diinspeksi.</p>
        </div>
      </div>
      <div class="grid gap-3 md:grid-cols-2 text-sm">
        <div class="rounded-xl border border-brand-100 p-3">
          <div class="mb-1 font-medium">Web & Mobile</div>
          <p>Kirim <b>deep link</b> dengan DID pengguna untuk handshake identitas dan membuat <i>session proof</i> (JWT/JWS).</p>
          <pre class="mt-2 rounded-xl bg-gray-950 p-3 text-xs text-gray-100"><code id="deeplink">example-app://connect?did=did:example:…&amp;nonce=123456</code></pre>
        </div>
        <div class="rounded-xl border border-brand-100 p-3">
          <div class="mb-1 font-medium">IoT & Edge</div>
          <ul class="list-disc pl-5">
            <li>Hash payload ➜ simpan pointer (CID)</li>
            <li>Rujuk CID pada event ledger</li>
            <li>Verifier cocokan hash & tanda tangan</li>
          </ul>
        </div>
        <div class="rounded-xl border border-brand-100 p-3 md:col-span-2">
          <div class="mb-1 font-medium">Interoperabilitas</div>
          <p>Gunakan standar terbuka (W3C VC, DID Method, JWS) agar bukti dapat diverifikasi lintas platform.</p>
        </div>
      </div>
    </section>

    <footer class="mx-auto mt-8 max-w-3xl text-center text-xs text-gray-500">
      Ini adalah <b>simulasi edukasi</b>. Untuk produksi gunakan DID method & registry nyata, implementasi VC sesuai spesifikasi, serta jaringan/storage terdesentralisasi sesungguhnya.
    </footer>
  </div>

  <script>
    // ===== Utilities =====
    const enc = new TextEncoder();
    const dec = new TextDecoder();

    async function sha256Hex(input) {
      const data = typeof input === 'string' ? enc.encode(input) : input;
      const hash = await crypto.subtle.digest('SHA-256', data);
      return [...new Uint8Array(hash)].map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // base58btc (Bitcoin alphabet)
    const B58_ALPH = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    function b58encode(bytes) {
      let x = BigInt('0x' + [...bytes].map(b=>b.toString(16).padStart(2,'0')).join(''));
      let out = '';
      while (x > 0n) { const mod = x % 58n; out = B58_ALPH[Number(mod)] + out; x = x / 58n; }
      for (let i=0; i<bytes.length && bytes[i] === 0; i++) out = '1' + out;
      return out || '1';
    }

    function b64urlFromBytes(bytes) {
      let bin = '';
      bytes.forEach(b => bin += String.fromCharCode(b));
      let b64 = btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
      return b64;
    }

    function b64url(str) {
      return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
    }

    function b64urlToBytes(b64u) {
      const b64 = (b64u + '==').replace(/-/g, '+').replace(/_/g, '/');
      const bin = atob(b64);
      const out = new Uint8Array(bin.length);
      for (let i=0; i<bin.length; i++) out[i] = bin.charCodeAt(i);
      return out;
    }

    function download(filename, text) {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], { type: 'application/json' }));
      a.download = filename;
      a.click();
    }

    async function exportJwk(key) { return await crypto.subtle.exportKey('jwk', key); }

    async function deriveDidExampleFromJwk(jwk) {
      const material = JSON.stringify({ kty: jwk.kty, crv: jwk.crv, x: jwk.x, y: jwk.y, n: jwk.n, e: jwk.e });
      const fp = await sha256Hex(material);
      return `did:example:${fp.slice(0, 16)}`;
    }

    // did:key (ed25519) = multibase(base58btc, 0xed 0x01 || rawPublicKey)
    function didKeyFromEd25519RawPublic(raw32) {
      const prefix = new Uint8Array([0xed, 0x01]);
      const bytes = new Uint8Array(prefix.length + raw32.length);
      bytes.set(prefix, 0); bytes.set(raw32, prefix.length);
      const mb = 'z' + b58encode(bytes);
      return 'did:key:' + mb;
    }

    async function signJson({ privateKey, payload, alg }) {
      const header = { alg, typ: 'JWT' };
      const encodedHeader = b64url(JSON.stringify(header));
      const encodedPayload = b64url(JSON.stringify(payload));
      const toSign = enc.encode(`${encodedHeader}.${encodedPayload}`);
      const sig = await crypto.subtle.sign(alg === 'EdDSA' ? { name: 'Ed25519' } : { name: 'ECDSA', hash: 'SHA-256' }, privateKey, toSign);
      const encodedSig = b64urlFromBytes(new Uint8Array(sig));
      return `${encodedHeader}.${encodedPayload}.${encodedSig}`;
    }

    async function verifyJson({ publicKey, jws, alg }) {
      const [h, p, s] = jws.split('.');
      const toVerify = enc.encode(`${h}.${p}`);
      const sigBytes = b64urlToBytes(s);
      const ok = await crypto.subtle.verify(alg === 'EdDSA' ? { name: 'Ed25519' } : { name: 'ECDSA', hash: 'SHA-256' }, publicKey, sigBytes, toVerify);
      const payloadJson = atob(p.replace(/-/g, '+').replace(/_/g, '/'));
      const payload = JSON.parse(payloadJson);
      return { ok, payload };
    }

    // ===== State (in-memory) =====
    const state = {
      didMethod: 'example', // 'example' | 'didkey'
      keyPair: null, // { publicKey, privateKey, did, pubJwk, alg }
      vcPayload: null,
      jws: null,
      chain: [],
      cid: null,
      storagePointer: null,
      agentLog: [],
    };

    // ===== Ledger helpers =====
    function createGenesisBlock() {
      return { index: 0, prevHash: '0'.repeat(64), timestamp: new Date().toISOString(), data: { genesis: true }, hash: '' };
    }
    async function hashBlock(b) {
      const body = `${b.index}|${b.prevHash}|${b.timestamp}|${JSON.stringify(b.data)}`;
      return await sha256Hex(body);
    }

    // ===== UI refs =====
    const didRadios = document.getElementsByName('didMethod');
    const w3Token = document.getElementById('w3Token');

    const didValue = document.getElementById('didValue');
    const algoLabel = document.getElementById('algoLabel');
    const btnGenDID = document.getElementById('btnGenDID');
    const btnIssueVC = document.getElementById('btnIssueVC');
    const btnVerifyVC = document.getElementById('btnVerifyVC');
    const vcPayloadEl = document.getElementById('vcPayload');
    const vcJwsEl = document.getElementById('vcJws');
    const verifyBadge = document.getElementById('verifyBadge');

    const fileText = document.getElementById('fileText');
    const btnStoreText = document.getElementById('btnStoreText');
    const btnUploadIPFS = document.getElementById('btnUploadIPFS');
    const cidValue = document.getElementById('cidValue');

    const eventNote = document.getElementById('eventNote');
    const storagePtr = document.getElementById('storagePtr');
    const chainBody = document.getElementById('chainBody');
    const btnAppendEvent = document.getElementById('btnAppendEvent');

    const btnRunAgent = document.getElementById('btnRunAgent');
    const agentLogEl = document.getElementById('agentLog');

    const btnExport = document.getElementById('btnExport');
    const deeplink = document.getElementById('deeplink');

    const previewDID = document.getElementById('previewDID');
    const previewVC = document.getElementById('previewVC');
    const previewCID = document.getElementById('previewCID');
    const previewLedger = document.getElementById('previewLedger');

    // ===== Init =====
    (async function init() {
      state.chain.push(createGenesisBlock());
      state.chain[0].hash = await hashBlock(state.chain[0]);
      renderChain();
      for (const r of didRadios) r.addEventListener('change', () => { state.didMethod = r.value; renderIdentity(); });
    })();

    // ===== Renders =====
    function renderIdentity() {
      didValue.textContent = state.keyPair ? state.keyPair.did : '— belum dibuat —';
      btnIssueVC.disabled = !state.keyPair;
      btnVerifyVC.disabled = !state.keyPair || !state.jws;
      algoLabel.textContent = state.keyPair ? (state.keyPair.alg === 'EdDSA' ? 'Ed25519 (EdDSA)' : 'P‑256 (ES256)') : 'P‑256 (ES256)';
      deeplink.textContent = `example-app://connect?did=${state.keyPair ? state.keyPair.did : 'did:example:…'}&nonce=123456`;
      previewDID.textContent = state.keyPair ? state.keyPair.did : '—';
    }

    function renderVC() {
      vcPayloadEl.textContent = state.vcPayload ? JSON.stringify(state.vcPayload, null, 2) : '—';
      vcJwsEl.textContent = state.jws || '—';
      btnVerifyVC.disabled = !state.keyPair || !state.jws;
      verifyBadge.classList.add('hidden');
      previewVC.textContent = state.vcPayload ? (state.vcPayload.type || []).join(', ') + ' ✓' : '—';
    }

    function renderStorage() {
      cidValue.textContent = state.cid || '— belum ada —';
      storagePtr.textContent = state.storagePointer || '— belum ada —';
      previewCID.textContent = state.cid || '—';
    }

    function renderChain() {
      chainBody.innerHTML = '';
      state.chain.forEach(b => {
        const tr = document.createElement('tr');
        tr.className = 'odd:bg-white even:bg-brand-50/30';
        tr.innerHTML = `
          <td class="px-3 py-2 align-top font-mono text-xs">${b.index}</td>
          <td class="px-3 py-2 align-top text-xs">${new Date(b.timestamp).toLocaleString()}</td>
          <td class="px-3 py-2 align-top text-xs">${b.data?.note ? b.data.note : 'Genesis'}</td>
          <td class="px-3 py-2 align-top font-mono text-[10px]">${(b.prevHash || '').slice(0,10)}…</td>
          <td class="px-3 py-2 align-top font-mono text-[10px]">${(b.hash || '').slice(0,10)}…</td>`;
        chainBody.appendChild(tr);
      });
      previewLedger.textContent = state.chain.length > 1 ? `${state.chain.length-1} event(s)` : 'Genesis only';
    }

    function renderAgentLog() {
      if (state.agentLog.length === 0) {
        agentLogEl.innerHTML = '<div class="text-gray-500">Belum ada keluaran agen. Klik <b>Run Agent</b>.</div>';
        return;
      }
      agentLogEl.innerHTML = '';
      state.agentLog.forEach(entry => {
        const wrap = document.createElement('div');
        wrap.className = 'rounded-xl border border-brand-100 p-3';
        wrap.innerHTML = `<div class=\"mb-1 text-xs text-gray-500\">${entry.time}</div>`;
        const ul = document.createElement('ul');
        ul.className = 'mb-2 list-disc pl-5 text-sm';
        entry.suggestions.forEach(s => {
          const li = document.createElement('li');
          li.textContent = s;
          ul.appendChild(li);
        });
        wrap.appendChild(ul);
        if (entry.attestation) {
          const det = document.createElement('details');
          det.className = 'text-xs';
          const sum = document.createElement('summary');
          sum.className = 'cursor-pointer select-none text-brand-700';
          sum.textContent = 'Signed attestation (JWS)';
          det.appendChild(sum);
          const pre = document.createElement('pre');
          pre.className = 'mt-2 max-h-40 overflow-auto rounded-xl bg-gray-950 p-3 text-xs text-gray-100';
          const code = document.createElement('code');
          code.textContent = entry.attestation;
          pre.appendChild(code);
          det.appendChild(pre);
          wrap.appendChild(det);
        }
        agentLogEl.appendChild(wrap);
      });
    }

    // ===== Handlers =====
    btnGenDID.addEventListener('click', async () => {
      try {
        const method = state.didMethod;
        if (method === 'didkey' && crypto?.subtle?.generateKey) {
          // Try Ed25519
          let kp;
          try {
            kp = await crypto.subtle.generateKey({ name: 'Ed25519' }, true, ['sign', 'verify']);
            const pubRaw = new Uint8Array(await crypto.subtle.exportKey('raw', kp.publicKey));
            const did = didKeyFromEd25519RawPublic(pubRaw);
            state.keyPair = { ...kp, did, pubJwk: null, alg: 'EdDSA' };
          } catch (e) {
            console.warn('Ed25519 tidak didukung, fallback ke P‑256', e);
            // Fallback P‑256 demo
            const p256 = await crypto.subtle.generateKey({ name: 'ECDSA', namedCurve: 'P-256' }, true, ['sign','verify']);
            const pubJwk = await crypto.subtle.exportKey('jwk', p256.publicKey);
            const did = await deriveDidExampleFromJwk(pubJwk);
            state.keyPair = { ...p256, did, pubJwk, alg: 'ES256' };
            state.didMethod = 'example';
            for (const r of didRadios) if (r.value==='example') r.checked = true;
          }
        } else {
          // P‑256 demo
          const p256 = await crypto.subtle.generateKey({ name: 'ECDSA', namedCurve: 'P-256' }, true, ['sign','verify']);
          const pubJwk = await crypto.subtle.exportKey('jwk', p256.publicKey);
          const did = await deriveDidExampleFromJwk(pubJwk);
          state.keyPair = { ...p256, did, pubJwk, alg: 'ES256' };
        }
        state.vcPayload = null; state.jws = null;
        renderIdentity();
        renderVC();
      } catch (e) {
        alert('Gagal generate DID: ' + e.message);
      }
    });

    btnIssueVC.addEventListener('click', async () => {
      if (!state.keyPair) return;
      const credential = {
        '@context': [
          'https://www.w3.org/2018/credentials/v1',
          { supplyChainLearner: 'https://example.org/definitions#supplyChainLearner' }
        ],
        id: `urn:uuid:${crypto.randomUUID()}`,
        type: ['VerifiableCredential', 'PlaygroundCredential'],
        issuer: state.keyPair.did,
        issuanceDate: new Date().toISOString(),
        credentialSubject: {
          id: state.keyPair.did,
          name: 'Web3 Simulator User',
          achievement: { type: 'supplyChainLearner', title: 'Understands DID, VC, and Traceability' },
        },
      };
      state.vcPayload = credential;
      const alg = state.keyPair.alg === 'EdDSA' ? 'EdDSA' : 'ES256';
      state.jws = await signJson({ privateKey: state.keyPair.privateKey, payload: credential, alg });
      renderVC();
    });

    btnVerifyVC.addEventListener('click', async () => {
      if (!state.keyPair || !state.jws) return;
      const alg = state.keyPair.alg === 'EdDSA' ? 'EdDSA' : 'ES256';
      const result = await verifyJson({ publicKey: state.keyPair.publicKey, jws: state.jws, alg });
      verifyBadge.classList.remove('hidden');
      verifyBadge.textContent = `Verifikasi: ${result.ok ? 'VALID' : 'TIDAK VALID'}`;
      verifyBadge.className = `rounded-xl border p-3 text-sm ${result.ok ? 'border-emerald-200 bg-emerald-50 text-emerald-800' : 'border-rose-200 bg-rose-50 text-rose-800'}`;
    });

    btnStoreText.addEventListener('click', async () => {
      const hex = await sha256Hex(fileText.value);
      const fakeCid = `cid-${hex.slice(0,46)}`;
      state.cid = fakeCid;
      state.storagePointer = fakeCid;
      renderStorage();
    });

    btnUploadIPFS.addEventListener('click', async () => {
      if (!w3Token.value) { alert('Masukkan token web3.storage terlebih dahulu.'); return; }
      try {
        const body = new Blob([fileText.value], { type: 'text/plain' });
        const res = await fetch('https://api.web3.storage/upload', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + w3Token.value },
          body
        });
        if (!res.ok) throw new Error('Upload gagal: ' + res.status);
        const json = await res.json();
        const realCid = json.cid || json?.value?.cid || null;
        if (!realCid) throw new Error('Respons tidak berisi CID');
        state.cid = realCid;
        state.storagePointer = realCid;
        renderStorage();
      } catch (e) {
        alert('Gagal upload ke IPFS: ' + e.message + '
Menggunakan mode simulasi sebagai fallback.');
      }
    });

    btnAppendEvent.addEventListener('click', async () => {
      const last = state.chain[state.chain.length - 1];
      const block = {
        index: state.chain.length,
        prevHash: last.hash,
        timestamp: new Date().toISOString(),
        data: { note: eventNote.value, storage: state.storagePointer || null },
        hash: ''
      };
      block.hash = await hashBlock(block);
      state.chain.push(block);
      renderChain();
    });

    btnRunAgent.addEventListener('click', async () => {
      const suggestions = [];
      if (!state.cid) suggestions.push('Tidak ada pointer storage (CID). Simpan/unggah metadata terlebih dahulu.');
      if (state.chain.length < 2) suggestions.push('Ledger baru genesis. Tambahkan event pemrosesan/pengiriman.');
      if (state.keyPair && !state.jws) suggestions.push('Identitas sudah ada namun belum ada credential. Issue VC.');
      if (!state.keyPair) suggestions.push('Generate DID agar bisa menandatangani attestasi.');

      let attestation = null;
      if (state.keyPair) {
        const payload = { kind: 'Attestation', sub: state.keyPair.did, ts: Date.now(), msg: 'Operator attests pallet sealed.' };
        const alg = state.keyPair.alg === 'EdDSA' ? 'EdDSA' : 'ES256';
        attestation = await signJson({ privateKey: state.keyPair.privateKey, payload, alg });
      }
      state.agentLog.unshift({ time: new Date().toLocaleString(), suggestions, attestation });
      renderAgentLog();
    });

    btnExport.addEventListener('click', () => {
      const data = {
        identity: state.keyPair ? { did: state.keyPair.did, alg: state.keyPair.alg } : null,
        vcJWS: state.jws || null,
        storage: { cid: state.cid || null, preview: fileText.value.slice(0, 100) },
        supplyChain: state.chain,
        agent: state.agentLog,
      };
      download('nafsflow-web3-sim-export.json', JSON.stringify(data, null, 2));
    });
  </script>

  <script src="/web-static/js/blocks-loader.js" defer></script>
  
</body>
</html>
