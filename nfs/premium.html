<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nafsgen.v2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
          colors: {
            "primary-purple": "#5C0099",
            "dark-purple": "#1f1033",
          },
        },
      },
    };
  </script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
    .aspect-9-16 { aspect-ratio: 9 / 16; }
    .download-overlay { background-color: rgba(0,0,0,0.6); transition: opacity .2s ease; }
    .file-upload-box { border: 2px dashed #6b7280; transition: border-color .2s ease; }
    .file-upload-box:hover { border-color: #a78bfa; }
    .active-button { background-color: #a78bfa; color: white; box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    .btn { @apply py-3 px-4 rounded-lg font-semibold transition-colors; }
  </style>
</head>
<body class="bg-dark-purple text-gray-100 font-sans min-h-screen">
  <!-- LAYOUT: 2 kolom, kiri menu; kanan generator -->
  <div class="max-w-7xl mx-auto p-4 lg:p-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold">nafsgen.v2</h1>
      <div class="text-xs text-gray-300">Demo single-file · Frontend only</div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- KIRI: MENU / PENGATURAN -->
      <aside class="lg:col-span-4 space-y-6 bg-primary-purple/30 border border-primary-purple/40 rounded-2xl p-4 lg:p-6">
        <h2 class="text-xl font-semibold">Pengaturan</h2>

        <!-- Provider & API Key -->
        <section class="space-y-3">
          <label class="block text-sm font-medium">Penyedia</label>
          <select id="provider" class="w-full bg-white/10 border border-white/20 rounded-lg p-2">
            <option value="openai">OpenAI – gpt-image-1 (gambar)</option>
            <option value="none">Tanpa API (hanya video dari gambar lokal)</option>
          </select>

          <label class="block text-sm font-medium mt-2">API Key</label>
          <input id="apiKey" type="password" placeholder="sk-..." class="w-full bg-white/10 border border-white/20 rounded-lg p-2" />
          <p class="text-xs text-gray-300">Kunci hanya dipakai di browser Anda. Untuk produksi, gunakan proxy server sendiri untuk alasan keamanan/CORS.</p>
          <label class="block text-sm font-medium mt-2">(Opsional) URL Proxy</label>
          <input id="proxyUrl" type="text" placeholder="https://proxy-domain.com/openai" class="w-full bg-white/10 border border-white/20 rounded-lg p-2" />
        </section>

        <!-- Prompt -->
        <section class="space-y-2">
          <label class="block text-sm font-medium">Prompt Gambar</label>
          <textarea id="prompt" rows="3" class="w-full bg-white/10 border border-white/20 rounded-lg p-2" placeholder="Contoh: foto produk sepatu putih di studio minimalis, lighting lembut, 9:16"></textarea>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-xs">Ukuran</label>
              <select id="imageSize" class="w-full bg-white/10 border border-white/20 rounded-lg p-2">
                <option value="1024x1024">1024x1024</option>
                <option value="1024x1792">1024x1792 (9:16)</option>
                <option value="1792x1024">1792x1024 (16:9)</option>
              </select>
            </div>
            <div>
              <label class="block text-xs">Jumlah</label>
              <input id="imageCount" type="number" min="1" max="6" value="6" class="w-full bg-white/10 border border-white/20 rounded-lg p-2" />
            </div>
          </div>
        </section>

        <!-- Upload referensi -->
        <section class="space-y-2">
          <label class="block text-sm font-medium">Unggah Foto Referensi (opsional, maksimal 2)</label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <label class="relative block w-full aspect-video rounded-lg file-upload-box text-center p-3 cursor-pointer">
              <input type="file" id="imageUpload1" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" />
              <span class="block text-sm">Gambar 1</span>
            </label>
            <label class="relative block w-full aspect-video rounded-lg file-upload-box text-center p-3 cursor-pointer">
              <input type="file" id="imageUpload2" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" />
              <span class="block text-sm">Gambar 2</span>
            </label>
          </div>
        </section>

        <!-- Gaya & Model dummy (UI) -->
        <section class="space-y-2">
          <label class="block text-sm font-medium">Pilih Model</label>
          <div class="flex gap-2">
            <button data-gender="pria" class="btn bg-white/10 hover:bg-white/20 flex-1">Pria</button>
            <button data-gender="wanita" class="btn bg-white/10 hover:bg-white/20 flex-1">Wanita</button>
          </div>

          <label class="block text-sm font-medium mt-3">Pilih Gaya Video</label>
          <div class="grid grid-cols-2 gap-2">
            <button class="btn bg-white/10 hover:bg-white/20" data-style="iklan-pakaian">Iklan Pakaian</button>
            <button class="btn bg-white/10 hover:bg-white/20" data-style="iklan-makanan">Iklan Makanan</button>
            <button class="btn bg-white/10 hover:bg-white/20" data-style="makeup">Makeup</button>
            <button class="btn bg-white/10 hover:bg-white/20" data-style="natural">Natural</button>
            <button class="btn bg-white/10 hover:bg-white/20" data-style="story">Story</button>
            <button class="btn bg-white/10 hover:bg-white/20" data-style="sinematic">Sinematik</button>
          </div>
        </section>

        <!-- Actions -->
        <section class="flex gap-3 pt-2">
          <button id="btnGenerateImages" class="flex-1 btn bg-purple-600 hover:bg-purple-700 text-white">Generate Image</button>
          <button id="btnClear" class="btn bg-white/10 hover:bg-white/20">Clear</button>
        </section>

        <section class="pt-2">
          <button id="btnMakeVideo" class="w-full btn bg-emerald-600 hover:bg-emerald-700 text-white">Buat Video dari Gambar Terpilih</button>
          <p class="text-xs text-gray-300 mt-2">Video dibuat di browser (WebM) dari rangkaian gambar yang Anda pilih.</p>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <label class="text-xs">Durasi total (detik)
              <input id="videoDuration" type="number" value="6" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 mt-1" />
            </label>
            <label class="text-xs">FPS
              <input id="videoFPS" type="number" value="24" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 mt-1" />
            </label>
            <label class="text-xs">Resolusi
              <select id="videoSize" class="w-full bg-white/10 border border-white/20 rounded-lg p-2 mt-1">
                <option value="1024x1792">9:16 (1024x1792)</option>
                <option value="1080x1920">9:16 (1080x1920)</option>
                <option value="1024x1024">1:1 (1024x1024)</option>
                <option value="1920x1080">16:9 (1920x1080)</option>
              </select>
            </label>
          </div>
        </section>
      </aside>

      <!-- KANAN: GENERATOR / OUTPUT -->
      <main class="lg:col-span-8">
        <h2 class="text-xl font-semibold mb-3">Hasil</h2>
        <div id="status" class="text-sm text-gray-300 mb-3"></div>
        <div id="output" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
      </main>
    </div>
  </div>

  <template id="tpl-card">
    <div class="rounded-xl overflow-hidden shadow-md bg-gray-800 flex flex-col">
      <label class="relative w-full aspect-9-16 group block">
        <img class="w-full h-full object-cover select-none" />
        <input type="checkbox" class="absolute top-2 left-2 w-5 h-5" title="Pilih untuk video" />
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 download-overlay">
          <a class="text-white text-lg font-bold" download>Unduh</a>
        </div>
      </label>
      <div class="p-2 flex gap-2">
        <button class="flex-1 btn bg-purple-600 hover:bg-purple-700 text-white" data-action="solo-video">Video dari gambar ini</button>
        <a class="btn bg-white/10 hover:bg-white/20" data-action="open" target="_blank">Buka</a>
      </div>
    </div>
  </template>

  <script>
    // ====== STATE ======
    const el = (id) => document.getElementById(id);
    const providerSel = el('provider');
    const apiKeyInput = el('apiKey');
    const proxyUrlInput = el('proxyUrl');
    const promptInput = el('prompt');
    const sizeSel = el('imageSize');
    const countInput = el('imageCount');
    const output = el('output');
    const statusBox = el('status');
    const tpl = document.getElementById('tpl-card');

    const uploads = { one: null, two: null };
    const imgDataList = []; // {dataUrl, blobUrl}

    // Gender & style buttons (UI highlight)
    const genderButtons = document.querySelectorAll('[data-gender]');
    const styleButtons = document.querySelectorAll('[data-style]');
    let selectedGender = null, selectedStyle = null;
    genderButtons.forEach(b=>b.addEventListener('click',()=>{ genderButtons.forEach(x=>x.classList.remove('active-button')); b.classList.add('active-button'); selectedGender=b.dataset.gender; }));
    styleButtons.forEach(b=>b.addEventListener('click',()=>{ styleButtons.forEach(x=>x.classList.remove('active-button')); b.classList.add('active-button'); selectedStyle=b.dataset.style; }));

    // Uploads preview
    function bindUpload(inputId, key){
      const input = el(inputId);
      const box = input.closest('label');
      input.addEventListener('change', ev => {
        const file = ev.target.files?.[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          uploads[key] = { file, dataUrl: e.target.result };
          box.innerHTML = `<img src="${uploads[key].dataUrl}" class="w-full h-full object-cover rounded-lg"/>`;
        };
        reader.readAsDataURL(file);
      });
    }
    bindUpload('imageUpload1','one');
    bindUpload('imageUpload2','two');

    // ====== HELPERS ======
    const setStatus = (msg, kind='info') => {
      const color = kind==='error' ? 'text-rose-300' : kind==='ok' ? 'text-emerald-300' : 'text-gray-300';
      statusBox.className = `text-sm ${color} mb-3`;
      statusBox.textContent = msg;
    };

    async function b64ToBlobUrl(b64, mime='image/png'){
      const bin = atob(b64);
      const len = bin.length;
      const arr = new Uint8Array(len);
      for(let i=0;i<len;i++) arr[i]=bin.charCodeAt(i);
      const blob = new Blob([arr], {type: mime});
      return URL.createObjectURL(blob);
    }

    function addImageCard(srcUrl, filename='nafsgen.png'){
      const node = tpl.content.cloneNode(true);
      const img = node.querySelector('img');
      const a = node.querySelector('a[download]');
      const openBtn = node.querySelector('[data-action="open"]');
      img.src = srcUrl;
      a.href = srcUrl; a.download = filename;
      openBtn.href = srcUrl;
      const soloBtn = node.querySelector('[data-action="solo-video"]');
      soloBtn.addEventListener('click', () => makeVideo([srcUrl]));
      output.appendChild(node);
    }

    function ensureProxy(url){
      const proxy = proxyUrlInput.value.trim();
      if(!proxy) return url; // call direct (may kena CORS)
      try {
        const u = new URL(proxy);
        // simple: append path
        return u.toString().replace(/\/$/, '') + url;
      } catch { return url; }
    }

    // ====== IMAGE: OpenAI gpt-image-1 ======
    async function generateOpenAIImages(){
      const key = apiKeyInput.value.trim();
      if(!key){ setStatus('Masukkan API Key terlebih dahulu.', 'error'); return; }
      const prompt = promptInput.value.trim();
      if(!prompt){ setStatus('Tulis prompt gambar.', 'error'); return; }
      const n = Math.min(Math.max(parseInt(countInput.value||'1'),1),6);
      const size = sizeSel.value;

      // Build payload (tanpa image reference; untuk use case advance, perlu /images/edits)
      const body = { model: 'gpt-image-1', prompt, size, n, response_format: 'b64_json' };

      setStatus('Mengirim permintaan ke OpenAI…');
      try {
        const url = ensureProxy('/v1/images/generations');
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
          body: JSON.stringify(body),
        });
        if(!res.ok){ const t = await res.text(); throw new Error(`HTTP ${res.status}: ${t}`); }
        const data = await res.json();
        const list = data.data || [];
        if(!Array.isArray(list) || list.length===0){ setStatus('Tidak ada gambar dikembalikan.', 'error'); return; }
        setStatus(`Berhasil: ${list.length} gambar.`, 'ok');
        imgDataList.length = 0; // reset
        output.innerHTML = '';
        let i=1;
        for(const item of list){
          const url = await b64ToBlobUrl(item.b64_json, 'image/png');
          imgDataList.push(url);
          addImageCard(url, `nafsgen_${i++}.png`);
        }
      } catch(err){
        console.error(err);
        setStatus('Gagal generate: '+ err.message, 'error');
      }
    }

    // ====== VIDEO: WebM dari gambar terpilih (client-side) ======
    async function makeVideo(srcList){
      if(!srcList || srcList.length===0){
        // kumpulkan dari checkbox terpilih
        const checks = output.querySelectorAll('input[type="checkbox"]:checked');
        srcList = Array.from(checks).map(ch => ch.closest('label').querySelector('img').src);
        if(srcList.length===0){ setStatus('Pilih minimal 1 gambar (centang) untuk dibuat video.', 'error'); return; }
      }

      const [w,h] = el('videoSize').value.split('x').map(Number);
      const seconds = Math.max(1, parseFloat(el('videoDuration').value||'6'));
      const fps = Math.max(1, parseInt(el('videoFPS').value||'24'));

      // Durasi per gambar
      const per = seconds / srcList.length;

      // Siapkan canvas & stream
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d');
      const stream = canvas.captureStream(fps);
      const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
      const chunks = [];
      recorder.ondataavailable = e => e.data.size && chunks.push(e.data);

      setStatus('Merekam video di browser…');
      recorder.start();

      const drawImageFit = (image) => {
        const iw = image.width, ih = image.height;
        const cr = w/h, ir = iw/ih;
        let dw, dh, dx, dy;
        if(ir > cr){ // gambar terlalu lebar
          dh = h; dw = ir*h; dx = (w - dw)/2; dy = 0;
        } else { // gambar terlalu tinggi
          dw = w; dh = w/ir; dx = 0; dy = (h - dh)/2;
        }
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,w,h);
        ctx.drawImage(image, dx, dy, dw, dh);
      };

      for(const src of srcList){
        const img = await new Promise((ok,err)=>{ const i=new Image(); i.crossOrigin='anonymous'; i.onload=()=>ok(i); i.onerror=err; i.src=src; });
        const frames = Math.round(per * fps);
        for(let f=0; f<frames; f++){
          drawImageFit(img);
          await new Promise(r=>setTimeout(r, 0)); // yield
        }
      }

      recorder.stop();
      await new Promise(res=> recorder.onstop = res);
      const blob = new Blob(chunks, {type: 'video/webm'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'nafsgen_video.webm';
      document.body.appendChild(a); a.click(); a.remove();
      setStatus('Video WebM selesai dibuat dan diunduh.', 'ok');
    }

    // ====== EVENTS ======
    document.getElementById('btnGenerateImages').addEventListener('click', async () => {
      const provider = providerSel.value;
      output.innerHTML = '';
      imgDataList.length = 0;

      if(provider === 'openai'){
        await generateOpenAIImages();
      } else {
        // tanpa API: pakai placeholder agar UI tetap berfungsi
        setStatus('Mode tanpa API: menampilkan placeholder.', 'info');
        const n = Math.min(Math.max(parseInt(countInput.value||'1'),1),6);
        for(let i=0;i<n;i++){
          const url = `https://placehold.co/900x1600/312e81/ffffff?text=Image+${i+1}`;
          addImageCard(url, `placeholder_${i+1}.png`);
        }
      }
    });

    document.getElementById('btnMakeVideo').addEventListener('click', () => makeVideo());

    document.getElementById('btnClear').addEventListener('click', () => {
      output.innerHTML = ''; imgDataList.length = 0; setStatus('');
      document.querySelectorAll('.active-button').forEach(b=>b.classList.remove('active-button'));
      selectedGender = selectedStyle = null;
      ['imageUpload1','imageUpload2'].forEach(id=>{ const inp=el(id); inp.value=''; const box=inp.closest('label'); box.innerHTML='<span class="block text-sm">Unggah</span>'; });
    });
  </script>
</body>
</html>
