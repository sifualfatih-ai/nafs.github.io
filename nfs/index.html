<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tools AI Pro</title>

 <!-- Favicon (hindari 404) -->
  <link rel="icon" href="nafsweb.ico" />
  <link rel="shortcut icon" href="/nafs.github.io/nafsweb.ico" type="image/ico" />
  
  <!-- Tandai halaman NFS agar script global lain tidak me-redirect -->
  <script>window.__NFS_PAGE__ = true;</script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { 'primary-purple':'#5C0099','dark-purple':'#2E004D' }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    .aspect-9-16{aspect-ratio:9/16}
    .download-overlay{background:rgba(0,0,0,.6);transition:opacity .3s ease;cursor:pointer}
    .file-upload-box{border:2px dashed #6b7280;transition:border-color .2s ease}
    .file-upload-box:hover{border-color:#a78bfa}
    .active-button{background:#a78bfa;color:#fff;box-shadow:0 4px 6px rgba(0,0,0,.1)}
  </style>
</head>

<body class="bg-dark-purple text-gray-100 font-sans p-4 min-h-screen flex items-center justify-center">

  <!-- Bar mini (status login) -->
  <div class="fixed top-3 right-3 z-50 bg-black/30 backdrop-blur px-3 py-2 rounded-lg text-sm hidden" id="nfsProfileBar">
    <span id="nfsEmail" class="opacity-90"></span>
    <button id="nfsLogout" class="ml-3 underline">Logout</button>
  </div>

  <div class="container mx-auto p-6 bg-primary-purple rounded-xl shadow-lg w-full max-w-7xl">
    <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6">nafsgen.v1</h1>
    <div class="flex flex-col lg:flex-row gap-8">

      <!-- Kolom Kiri: Input -->
      <div class="flex-1 space-y-6">
        <h2 class="text-2xl font-semibold mb-4">Pengaturan</h2>

        <!-- Upload 2 gambar -->
        <div>
          <p class="text-sm font-medium mb-2">Unggah Foto Produk</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <label for="image-upload-1" class="relative block w-full aspect-video rounded-lg file-upload-box text-center p-4 cursor-pointer">
              <input type="file" id="image-upload-1" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
              <span class="block text-xl font-bold mb-2">Unggah Gambar 1</span>
              <span class="block text-sm">klik atau seret & jatuhkan di sini</span>
            </label>
            <label for="image-upload-2" class="relative block w-full aspect-video rounded-lg file-upload-box text-center p-4 cursor-pointer">
              <input type="file" id="image-upload-2" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
              <span class="block text-xl font-bold mb-2">Unggah Gambar 2</span>
              <span class="block text-sm">klik atau seret & jatuhkan di sini</span>
            </label>
          </div>
        </div>

        <!-- Pilih model -->
        <div>
          <p class="text-sm font-medium mb-2">Pilih Model</p>
          <div class="flex space-x-4">
            <button class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-gender="pria">Pria</button>
            <button class="flex-1 py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-gender="wanita">Wanita</button>
          </div>
        </div>

        <!-- Pilih gaya -->
        <div>
          <p class="text-sm font-medium mb-2">Pilih Gaya Video</p>
          <div class="grid grid-cols-2 gap-4">
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="iklan-pakaian">Iklan Pakaian</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="iklan-makanan-ringan">Iklan Makanan Ringan</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="iklan-makeup">Iklan Makeup</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="natural">Natural</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="story">Story</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="sci-fi">Sci-fi</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="sinematic">Sinematik</button>
            <button class="py-3 px-6 rounded-lg font-semibold bg-gray-700 hover:bg-purple-400 transition-colors" data-style="cyberpunk">Cyberpunk</button>
          </div>
        </div>

        <!-- Tombol -->
        <div class="flex space-x-4">
          <button id="generate-image-button" class="flex-1 py-4 px-6 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition-colors shadow-md">
            Generate Image
          </button>
          <button id="clear-button" class="py-4 px-6 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-colors">
            Clear
          </button>
        </div>
      </div>

      <!-- Kolom Kanan: Output -->
      <div class="flex-1">
        <h2 class="text-2xl font-semibold mb-4">Hasil Generasi</h2>
        <div id="output-container" class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <!-- 6 placeholder -->
          <template id="ph">
            <div class="rounded-xl overflow-hidden shadow-md bg-gray-800 flex flex-col items-center">
              <div class="relative w-full aspect-9-16 group">
                <div class="w-full h-full bg-gray-600 flex items-center justify-center text-gray-400">
                  <span class="text-center p-4">Gambar<br>(Rasio 9:16)</span>
                </div>
                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 download-overlay transition-opacity">
                  <a href="#" download class="text-white text-lg font-bold">Unduh</a>
                </div>
              </div>
              <button class="w-full py-2 px-4 mt-2 mb-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors generate-video-button">Generate Video</button>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== SCRIPTS ====== -->
  <script type="module">
    import { auth, db } from "/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---- Blokir redirect ke react/vite (jaga-jaga jika ada script lama) ----
    (function(){
      const rx = /(\/react\/vite|\/react(\/|$)|\/vite(\/|$))/i;
      const A = window.location.assign.bind(window.location);
      const R = window.location.replace.bind(window.location);
      window.location.assign = (u)=> rx.test(String(u)) ? console.log("[NFS] blocked redirect:", u) : A(u);
      window.location.replace = (u)=> rx.test(String(u)) ? console.log("[NFS] blocked redirect:", u) : R(u);
    })();

    // ---- Guard Login + Whitelist ----
    const profBar = document.getElementById('nfsProfileBar');
    const emailSpan = document.getElementById('nfsEmail');
    const logoutBtn = document.getElementById('nfsLogout');

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        sessionStorage.setItem('prev_page', location.pathname + location.search);
        location.replace("/nfs/login.html");
        return;
      }
      const email = (user.email || '').toLowerCase();
      try {
        const snap = await getDoc(doc(db, 'allowedUsers', email));
        if (!(snap.exists() && snap.data()?.allowed === true)) {
          await signOut(auth);
          sessionStorage.setItem('prev_page', location.pathname + location.search);
          location.replace("/nfs/login.html");
          return;
        }
        // tampilkan bar status login
        profBar.classList.remove('hidden');
        emailSpan.textContent = email;
      } catch {
        await signOut(auth);
        sessionStorage.setItem('prev_page', location.pathname + location.search);
        location.replace("/nfs/login.html");
      }
    });

    // Logout â†’ selalu balik ke /nfs/login.html
    logoutBtn.addEventListener('click', async () => {
      await signOut(auth);
      location.replace("/nfs/login.html");
    });

    // ----------------- LOGIKA UI KAMU (tidak terkait auth) -----------------
    const outputContainer = document.getElementById('output-container');
    const genderButtons   = document.querySelectorAll('[data-gender]');
    const styleButtons    = document.querySelectorAll('[data-style]');
    const imageUpload1    = document.getElementById('image-upload-1');
    const imageUpload2    = document.getElementById('image-upload-2');
    const fileUploadBox1  = imageUpload1.closest('label');
    const fileUploadBox2  = imageUpload2.closest('label');
    const generateImageButton = document.getElementById('generate-image-button');
    const clearButton         = document.getElementById('clear-button');

    let selectedGender = null;
    let selectedStyle  = null;
    let uploadedImages = { 'image-1': null, 'image-2': null };

    genderButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        genderButtons.forEach(b=>b.classList.remove('active-button'));
        btn.classList.add('active-button');
        selectedGender = btn.dataset.gender;
      });
    });

    styleButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        styleButtons.forEach(b=>b.classList.remove('active-button'));
        btn.classList.add('active-button');
        selectedStyle = btn.dataset.style;
      });
    });

    imageUpload1.addEventListener('change',(e)=> handleImageUpload(e,'image-1',fileUploadBox1));
    imageUpload2.addEventListener('change',(e)=> handleImageUpload(e,'image-2',fileUploadBox2));

    function handleImageUpload(ev,key,box){
      const file = ev.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (e)=>{
        uploadedImages[key] = e.target.result;
        const img = new Image();
        img.onload = ()=>{ box.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg">`; };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    generateImageButton.addEventListener('click', ()=>{
      if ((!uploadedImages['image-1'] && !uploadedImages['image-2']) || !selectedGender || !selectedStyle) {
        alert('Silakan unggah setidaknya satu gambar dan pilih model serta gaya.');
        return;
      }
      outputContainer.innerHTML = '';
      for(let i=0;i<6;i++){
        const url = `https://placehold.co/900x1600/312e81/ffffff?text=Image+${i+1}`;
        const t = document.getElementById('ph').content.cloneNode(true);
        t.querySelector('img')?.remove; // template pakai bg saja
        t.querySelector('a').href = url;
        t.querySelector('a').download = `nafsgen_result_${i+1}.png`;
        outputContainer.appendChild(t);
      }
      document.querySelectorAll('.generate-video-button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          alert('Simulasi: Video Veo 2.0 berhasil dibuat. Mohon tunggu proses unduhan.');
          const link = document.createElement('a');
          link.href = 'https://www.w3schools.com/html/mov_bbb.mp4';
          link.download = 'nafsgen_video.mp4';
          document.body.appendChild(link); link.click(); link.remove();
        });
      });
    });

    clearButton.addEventListener('click', ()=>{
      selectedGender=null; selectedStyle=null;
      uploadedImages = { 'image-1': null, 'image-2': null };
      imageUpload1.value = ''; imageUpload2.value='';
      fileUploadBox1.innerHTML = `<span class="block text-xl font-bold mb-2">Unggah Gambar 1</span><span class="block text-sm">klik atau seret & jatuhkan di sini</span>`;
      fileUploadBox2.innerHTML = `<span class="block text-xl font-bold mb-2">Unggah Gambar 2</span><span class="block text-sm">klik atau seret & jatuhkan di sini</span>`;
      genderButtons.forEach(b=>b.classList.remove('active-button'));
      styleButtons.forEach(b=>b.classList.remove('active-button'));
      outputContainer.innerHTML = '';
      for(let i=0;i<6;i++){
        outputContainer.appendChild(document.getElementById('ph').content.cloneNode(true));
      }
    });
  </script>
</body>
</html>
