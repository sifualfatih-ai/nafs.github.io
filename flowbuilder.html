<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NafsFlow – Flow Builder + Preview + Run</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- EmailJS (opsional, hanya jika mau kirim email tanpa server) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    function NafsFlowBuilder() {
      const [steps, setSteps] = useState([]);
      const [selectedId, setSelectedId] = useState(null);
      const [name, setName] = useState("Flow – Pilih Template");
      const [tpl, setTpl] = useState("rental_mobil");

      // Tabs: Builder | Preview | Run
      const [tab, setTab] = useState("builder");

      // SETTINGS integrasi ringan
      const [settingsOpen, setSettingsOpen] = useState(false);
      const [cfg, setCfg] = useState({
        emailjsService: "",
        emailjsTemplate: "",
        emailjsPublicKey: "",
        sheetsWebhook: "",
        whatsappNumber: "6281234567890",
      });

      // SIMULATOR context
      const [simCtx, setSimCtx] = useState({ nama: "Budi", email: "budi@example.com", deposit: 500000, telatJam: 0, keluhan: "Demam" });
      const [simIdx, setSimIdx] = useState(-1);
      const [simLogs, setSimLogs] = useState([]);
      const simActive = simIdx >= 0;

      // RUNTIME (Form renderer)
      const firstForm = useMemo(() => steps.find(s => s.type === "Form"), [steps]);
      const [runData, setRunData] = useState({});
      const [runLog, setRunLog] = useState([]);

      // Palette
      const palette = [
        { type: "Form", icon: "📝", desc: "Kumpulkan data awal" },
        { type: "Task", icon: "✅", desc: "Tugas manual ber-checklist" },
        { type: "Approval", icon: "🛂", desc: "Setuju/Tolak dengan komentar" },
        { type: "AutoAction", icon: "⚙️", desc: "Panggil API / generate dokumen" },
        { type: "Wait", icon: "⏳", desc: "Tunda X jam/hari" },
        { type: "Router", icon: "🔀", desc: "Cabang IF/ELSE berbasis data" },
        { type: "Notify", icon: "🔔", desc: "Kirim Email/WA" },
      ];

      // Helpers
      const newId = () => Math.random().toString(36).slice(2, 9);
      const clone = (v) => JSON.parse(JSON.stringify(v));
      const makeStep = (type) => ({ id: newId(), type, title: defaultTitle(type), assignee: "", slaHours: 0, config: defaultConfig(type) });

      function defaultTitle(type) {
        const map = { Form:"Form Intake", Task:"Tugas Manual", Approval:"Approval", AutoAction:"Aksi Otomatis", Wait:"Tunggu", Router:"Router IF/ELSE", Notify:"Notifikasi" };
        return map[type] || type;
      }
      function defaultConfig(type) {
        const cfg = {
          Form: { fields: [{ name: "nama", type: "text", required: true }] },
          AutoAction: { action: "webhook", url: "https://api.example.com/hook", method: "POST", payload: {} },
          Wait: { duration: 24, unit: "hours" },
          Router: { rules: [{ if: "true", goTo: "" }] },
          Notify: { channel: "email", template: "Pengingat" },
          Task: { checklist: ["Cek data"] },
          Approval: { roles: ["Supervisor"], threshold: 1 },
        };
        return cfg[type] || {};
      }

      // ================== TEMPLATES ==================
      const templates = {
        rental_mobil: {
          name: "Flow Rental Mobil",
          steps: [
            { type:"Form", title:"Form Pemesanan", assignee:"customer", config:{ fields:[
              { name:"nama", type:"text", required:true },
              { name:"email", type:"email", required:true },
              { name:"deposit", type:"number", required:true },
              { name:"tanggal_mulai", type:"date", required:true },
              { name:"tanggal_selesai", type:"date", required:true },
            ]}},
            { type:"Router", title:"Cek Deposit", assignee:"system", config:{ rules:[
              { if:"deposit < 500000", goTo:"manual_review" },
              { if:"deposit >= 500000", goTo:"approve" },
            ]}},
            { type:"Approval", title:"Manual Review", assignee:"ops", slaHours:2, config:{ roles:["Supervisor"], threshold:1 }, label:"manual_review" },
            { type:"Approval", title:"Approval Sewa", assignee:"ops", slaHours:1, config:{ roles:["Admin"], threshold:1 }, label:"approve" },
            { type:"AutoAction", title:"Generate Kontrak", assignee:"system", config:{ action:"generate_pdf" } },
            { type:"Notify", title:"Kirim Kontrak & Pembayaran", assignee:"system", config:{ channel:"email", template:"Link Kontrak + Pembayaran" } },
            { type:"Task", title:"Serah Terima Unit", assignee:"kurir", slaHours:4, config:{ checklist:["Foto kendaraan","Catat KM","Tanda tangan"] } },
            { type:"Wait", title:"Pengingat H-1 Pengembalian", assignee:"system", config:{ duration:24, unit:"hours" } },
            { type:"Notify", title:"Remind Pengembalian", assignee:"system", config:{ channel:"email", template:"Pengingat H-1" } },
            { type:"Task", title:"Pemeriksaan Pengembalian", assignee:"ops", slaHours:2, config:{ checklist:["Cek bensin","Foto body","Hitung denda telat"] } },
          ]
        },
        agen_properti: {
          name: "Flow Agen Properti",
          steps: [
            { type:"Form", title:"Form Lead Properti", assignee:"marketing", config:{ fields:[
              { name:"nama", type:"text", required:true },
              { name:"telepon", type:"text", required:true },
              { name:"minat_properti", type:"text", required:true },
              { name:"budget", type:"number", required:false },
            ]}},
            { type:"Router", title:"Kualifikasi Lead", assignee:"system", config:{ rules:[
              { if:"budget >= 500000000", goTo:"prioritas" },
              { if:"budget < 500000000", goTo:"biasa" },
            ]}},
            { type:"Task", title:"Follow Up Telepon", assignee:"sales", slaHours:4, label:"prioritas", config:{ checklist:["Telepon 1","Kirim brosur","Jadwal kunjungan"] } },
            { type:"Task", title:"Follow Up WhatsApp", assignee:"sales", slaHours:8, label:"biasa", config:{ checklist:["Chat perkenalan","Kirim katalog","Tanya waktu kunjungan"] } },
            { type:"Approval", title:"Persetujuan Kunjungan", assignee:"koordinator", slaHours:4, config:{ roles:["Koordinator"], threshold:1 } },
            { type:"AutoAction", title:"Kirim Jadwal + Lokasi", assignee:"system", config:{ action:"send_calendar" } },
            { type:"Task", title:"Pendampingan Kunjungan", assignee:"sales", slaHours:24, config:{ checklist:["Cek kunci","Dokumentasi","Form feedback"] } },
            { type:"Notify", title:"Tindak Lanjut Penawaran", assignee:"system", config:{ channel:"email", template:"Proposal & Kalkulasi KPR" } },
          ]
        },
        klinik: {
          name: "Flow Klinik",
          steps: [
            { type:"Form", title:"Registrasi Pasien", assignee:"frontdesk", config:{ fields:[
              { name:"nama", type:"text", required:true },
              { name:"nik", type:"text", required:true },
              { name:"keluhan", type:"text", required:true },
            ]}},
            { type:"Router", title:"Triase", assignee:"perawat", config:{ rules:[
              { if:"keluhan?.toLowerCase?.().includes('sesak') || keluhan?.toLowerCase?.().includes('darurat')", goTo:"prioritas" },
              { if:"true", goTo:"umum" },
            ]}},
            { type:"Task", title:"Pemeriksaan Awal (Prioritas)", assignee:"perawat senior", slaHours:1, label:"prioritas", config:{ checklist:["Cek nadi","Cek tekanan darah","Oksigen"] } },
            { type:"Task", title:"Pemeriksaan Awal", assignee:"perawat", slaHours:2, label:"umum", config:{ checklist:["Cek suhu","Cek tekanan darah","Catat riwayat"] } },
            { type:"Approval", title:"Diagnosa Dokter", assignee:"dokter", slaHours:4, config:{ roles:["Dokter Umum"], threshold:1 } },
            { type:"AutoAction", title:"Generate Resep", assignee:"system", config:{ action:"generate_pdf" } },
            { type:"Notify", title:"Kirim Detail Obat & Anjuran", assignee:"system", config:{ channel:"email", template:"Resep & Instruksi" } },
            { type:"Task", title:"Penebusan Obat", assignee:"apotek", slaHours:4, config:{ checklist:["Verifikasi resep","Serahkan obat","Catat pembayaran"] } },
          ]
        },
        konten_agency: {
          name: "Flow Konten Agency",
          steps: [
            { type:"Form", title:"Brief Klien", assignee:"klien", config:{ fields:[
              { name:"nama_brand", type:"text", required:true },
              { name:"tujuan_kampanye", type:"text", required:true },
              { name:"deadline", type:"date", required:true },
            ]}},
            { type:"Approval", title:"Review Strategi", assignee:"strategist", slaHours:12, config:{ roles:["Strategist"], threshold:1 } },
            { type:"Task", title:"Produksi Konten", assignee:"creator", slaHours:24, config:{ checklist:["Script","Shooting","Editing","Thumbnail"] } },
            { type:"Approval", title:"Approval Klien", assignee:"klien", slaHours:24, config:{ roles:["Client"], threshold:1 } },
            { type:"AutoAction", title:"Jadwalkan Publish", assignee:"system", config:{ action:"schedule_post" } },
            { type:"Notify", title:"Kirim Laporan Performansi (H+3)", assignee:"system", config:{ channel:"email", template:"Laporan Ringkas" } },
          ]
        },
        paud_kober: {
          name: "Flow Administrasi PAUD/Kober",
          steps: [
            { type:"Form", title:"Pendaftaran Siswa", assignee:"wali", config:{ fields:[
              { name:"nama_anak", type:"text", required:true },
              { name:"ttl", type:"text", required:true },
              { name:"wali", type:"text", required:true },
            ]}},
            { type:"Task", title:"Verifikasi Dokumen", assignee:"admin", slaHours:24, config:{ checklist:["Akte","KK","KTP Wali"] } },
            { type:"Approval", title:"Persetujuan Kepala Sekolah", assignee:"kepsek", slaHours:48, config:{ roles:["Kepala Sekolah"], threshold:1 } },
            { type:"AutoAction", title:"Generate Surat Penerimaan", assignee:"system", config:{ action:"generate_pdf" } },
            { type:"Notify", title:"Kirim Info Bayar & Perlengkapan", assignee:"system", config:{ channel:"email", template:"Informasi Administrasi" } },
            { type:"Task", title:"Orientasi & Penyerahan Buku", assignee:"guru", slaHours:72, config:{ checklist:["Brief wali","Serah buku","Jadwal kegiatan"] } },
          ]
        },
      };
      // =================================================

      function loadTemplateByKey(key) {
        const t = templates[key];
        if (!t) return;
        const withIds = t.steps.map(s => ({ id:newId(), slaHours:0, assignee:"", config:{}, ...s }));
        setSteps(withIds);
        setSelectedId(withIds[0]?.id || null);
        setName(t.name);
        setSimIdx(-1); setSimLogs([]);
        setRunData({});
        setTab("builder");
      }

      // Drag dari palette → canvas
      const onDragStartPalette = (e, type) => { e.dataTransfer.setData("application/x-nafs-step", type); e.dataTransfer.effectAllowed = "copy"; };
      const onDropCanvas = (e, insertIndex = steps.length) => {
        e.preventDefault();
        const type = e.dataTransfer.getData("application/x-nafs-step");
        const moveId = e.dataTransfer.getData("application/x-nafs-move-id");
        if (type) {
          const created = makeStep(type);
          const next = clone(steps); next.splice(insertIndex, 0, created);
          setSteps(next); setSelectedId(created.id);
        } else if (moveId) {
          const idx = steps.findIndex((s) => s.id === moveId); if (idx === -1) return;
          const next = clone(steps); const [moved] = next.splice(idx, 1);
          const target = insertIndex > idx ? insertIndex - 1 : insertIndex; next.splice(target, 0, moved);
          setSteps(next); setSelectedId(moved.id);
        }
      };
      const onDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = "copy"; };
      const onDragStartStep = (e, id) => { e.dataTransfer.setData("application/x-nafs-move-id", id); e.dataTransfer.effectAllowed = "move"; };

      // Edit
      const updateStep = (id, patch) => setSteps((prev) => prev.map((s) => (s.id === id ? { ...s, ...patch } : s)));
      const removeStep = (id) => setSteps((prev) => prev.filter((s) => s.id !== id));

      // Export JSON
      const asSpec = () => ({ name, version: 1, createdAt: new Date().toISOString(), steps: steps.map(({ id, ...rest }) => rest) });
      const downloadJson = () => {
        const blob = new Blob([JSON.stringify(asSpec(), null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob); const a = document.createElement("a");
        a.href = url; a.download = slugify(name) + ".nafsflow.json"; a.click(); URL.revokeObjectURL(url);
      };

      // SIMULATOR
      const startSim = () => { setSimIdx(0); setSimLogs([{ t: now(), m: `Mulai simulasi: ${name}` }]); };
      const resetSim = () => { setSimIdx(-1); setSimLogs([]); };
      const appendLog = (m) => setSimLogs((l) => [...l, { t: now(), m }]);
      const runCurrent = () => {
        const s = steps[simIdx]; if (!s) return;
        let note = "";
        if (s.type === "Form")      note = `mengisi form (${(s.config?.fields||[]).map(f=>f.name).join(', ')})`;
        if (s.type === "Approval")  note = `approval oleh ${s.assignee||'role'}`;
        if (s.type === "Task")      note = `tugas: ${(s.config?.checklist||[]).join('; ')}`;
        if (s.type === "Wait")      note = `menunggu ~${s.config?.duration||0} ${s.config?.unit||'jam'}`;
        if (s.type === "Notify")    note = `kirim ${s.config?.channel||'email'} template: ${s.config?.template||'-'}`;
        if (s.type === "AutoAction")note = `aksi ${s.config?.action||'webhook'} → ${s.config?.url||''}`;
        appendLog(`Step ${simIdx+1}: ${s.title} (${s.type}) — ${note}`);

        if (s.type === "Router") {
          const rules = s.config?.rules || [];
          const target = evalRouter(rules, { ...simCtx, ...runData });
          appendLog(`Router memilih jalur → ${target || 'tidak ada kecocokan'}`);
          const idxLabel = steps.findIndex(x => (x.label||'') === target);
          if (idxLabel >= 0) { setSimIdx(idxLabel); return; }
        }
        setSimIdx((i) => Math.min(i + 1, steps.length));
      };
      function evalRouter(rules, ctx){
        for (const r of rules){
          try {
            const fn = new Function(...Object.keys(ctx), `return (${r.if});`);
            if (fn(...Object.values(ctx))) return r.goTo;
          } catch (e) { appendLog(`Gagal evaluasi rule: ${r.if}`); }
        }
        return null;
      }

      // ===== PREVIEW (ringkasan + mini diagram) =====
      const preview = useMemo(() => {
        const count = { Form:0, Task:0, Approval:0, AutoAction:0, Wait:0, Router:0, Notify:0 };
        steps.forEach(s => count[s.type] = (count[s.type]||0) + 1);
        // buat node linear + tandai router
        const nodes = steps.map((s,i) => ({ idx:i+1, type:s.type, title:s.title, label:s.label || "" }));
        return { count, nodes };
      }, [steps]);

      // ===== RUN (Form renderer + mini integrations) =====
      function submitRunForm(e){
        e.preventDefault();
        // gabung data form ke runData + simCtx
        const merged = { ...simCtx, ...runData };
        setRunLog(log => [...log, `[${now()}] Form disubmit: ${JSON.stringify(runData)}`]);

        // Simulasi integrasi:
        fireSheets(merged);
        fireEmail(merged);
        fireWA(merged);

        // Simpan lokal
        localStorage.setItem("nafsflow_runData", JSON.stringify(merged));

        // Mulai simulator bila belum
        if (simIdx < 0 && steps.length) {
          setSimIdx(0);
          setSimLogs([{ t: now(), m: `Mulai simulasi: ${name}` }]);
        }
      }

      function fireEmail(payload){
        if (!cfg.emailjsService || !cfg.emailjsTemplate || !cfg.emailjsPublicKey) {
          setRunLog(log => [...log, `[${now()}] EmailJS: dilewati (tidak dikonfigurasi)`]);
          return;
        }
        try{
          emailjs.init(cfg.emailjsPublicKey);
          emailjs.send(cfg.emailjsService, cfg.emailjsTemplate, payload)
            .then(()=> setRunLog(log => [...log, `[${now()}] EmailJS: terkirim`] ))
            .catch(()=> setRunLog(log => [...log, `[${now()}] EmailJS: gagal kirim`] ));
        }catch(err){
          setRunLog(log => [...log, `[${now()}] EmailJS: error init`] );
        }
      }

      async function fireSheets(payload){
        if (!cfg.sheetsWebhook) {
          setRunLog(log => [...log, `[${now()}] Sheets Webhook: dilewati (tidak dikonfigurasi)`]);
          return;
        }
        try{
          await fetch(cfg.sheetsWebhook, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
          setRunLog(log => [...log, `[${now()}] Sheets Webhook: OK`] );
        }catch(e){
          setRunLog(log => [...log, `[${now()}] Sheets Webhook: gagal`] );
        }
      }

      function fireWA(payload){
        const num = cfg.whatsappNumber?.replace(/[^0-9]/g,'') || "";
        if (!num) {
          setRunLog(log => [...log, `[${now()}] WhatsApp: dilewati (no kosong)`]);
          return;
        }
        const msg = encodeURIComponent(`NafsFlow: ${name}\nNama: ${payload.nama||'-'}\nEmail: ${payload.email||'-'}\nDeposit/Keluhan: ${payload.deposit||payload.keluhan||'-'}`);
        const url = `https://wa.me/${num}?text=${msg}`;
        setRunLog(log => [...log, `[${now()}] WhatsApp: buka chat`]);
        window.open(url, "_blank");
      }

      return (
        <div className="min-h-screen bg-slate-50 text-slate-800">
          {/* Top Bar */}
          <header className="sticky top-0 z-40 border-b bg-white/80 backdrop-blur">
            <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-2">
              <a href="https://nafsflow.com" className="px-3 py-2 rounded-xl border hover:bg-slate-50">← Menu Utama</a>
              <div className="h-9 w-9 rounded-xl bg-slate-900 text-white grid place-items-center font-bold">NF</div>
              <input className="px-3 py-2 rounded-xl border w-64" value={name} onChange={(e) => setName(e.target.value)} />

              {/* Template Picker + Load + Settings */}
              <div className="flex items-center gap-2 ml-2">
                <select className="px-3 py-2 rounded-xl border bg-white"
                        value={tpl} onChange={(e)=>setTpl(e.target.value)} title="Pilih Template">
                  <option value="rental_mobil">Rental Mobil</option>
                  <option value="agen_properti">Agen Properti</option>
                  <option value="klinik">Klinik</option>
                  <option value="konten_agency">Konten Agency</option>
                  <option value="paud_kober">Administrasi PAUD/Kober</option>
                </select>
                <button onClick={()=>loadTemplateByKey(tpl)} className="px-3 py-2 rounded-xl border">Load Template</button>
                <button onClick={()=>setSettingsOpen(true)} className="px-3 py-2 rounded-xl border">Settings</button>
              </div>

              <div className="ml-auto flex items-center gap-2">
                <button onClick={downloadJson} className="px-3 py-2 rounded-xl bg-slate-900 text-white">Export JSON</button>
              </div>
            </div>

            {/* Tabs */}
            <div className="mx-auto max-w-7xl px-4 pb-3">
              <div className="inline-flex gap-1 bg-slate-100 p-1 rounded-xl border">
                {["builder","preview","run"].map(t => (
                  <button key={t}
                          onClick={()=>setTab(t)}
                          className={`px-3 py-1.5 rounded-lg ${tab===t?'bg-white border shadow-sm':'text-slate-600'}`}>
                    {t==="builder"?"Builder":t==="preview"?"Preview":"Run"}
                  </button>
                ))}
              </div>
            </div>
          </header>

          <div className="mx-auto max-w-7xl px-4 py-6 grid grid-cols-12 gap-6">
            {/* LEFT: Palette + Simulator/Run */}
            <aside className="col-span-12 lg:col-span-3 space-y-3">
              {/* Palette (selalu tampil di Builder) */}
              <div className={`${tab!=='builder' && 'opacity-60'} transition-opacity`}>
                <div className="text-sm text-slate-500">Blok Langkah</div>
                <div className="grid grid-cols-2 lg:grid-cols-1 gap-3 mt-2">
                  {palette.map((p) => (
                    <div key={p.type} draggable onDragStart={(e) => onDragStartPalette(e, p.type)}
                         className="p-4 rounded-2xl border bg-white cursor-grab active:cursor-grabbing"
                         title="Tarik ke kanvas untuk menambahkan">
                      <div className="font-medium flex items-center gap-2">{p.icon} {p.type}</div>
                      <div className="text-xs text-slate-500 mt-1">{p.desc}</div>
                    </div>
                  ))}
                </div>
              </div>

              {/* SIMULATOR */}
              <div className="mt-6 p-4 rounded-2xl border bg-white">
                <div className="font-medium">Simulator</div>
                <div className="text-xs text-slate-500 mt-1">Uji alur tanpa backend</div>
                <div className="mt-3 grid grid-cols-1 gap-2">
                  <LabeledInput label="Nama" value={simCtx.nama} onChange={(v)=>setSimCtx({...simCtx, nama:v})} />
                  <LabeledInput label="Email" value={simCtx.email} onChange={(v)=>setSimCtx({...simCtx, email:v})} />
                  <LabeledNumber label="Deposit" value={simCtx.deposit} onChange={(v)=>setSimCtx({...simCtx, deposit:v})} />
                  <LabeledNumber label="Telat (jam)" value={simCtx.telatJam} onChange={(v)=>setSimCtx({...simCtx, telatJam:v})} />
                  <LabeledInput label="Keluhan" value={simCtx.keluhan} onChange={(v)=>setSimCtx({...simCtx, keluhan:v})} />
                  <div className="flex gap-2 mt-2">
                    {!simActive ? (
                      <button className="px-3 py-2 rounded-xl bg-slate-900 text-white" onClick={startSim} disabled={steps.length===0}>Mulai</button>
                    ) : (
                      <>
                        <button className="px-3 py-2 rounded-xl border" onClick={runCurrent} disabled={simIdx>=steps.length}>Jalankan Step</button>
                        <button className="px-3 py-2 rounded-xl border" onClick={()=>setSimIdx(simIdx+1)} disabled={simIdx>=steps.length}>Lewati</button>
                        <button className="px-3 py-2 rounded-xl border" onClick={resetSim}>Reset</button>
                      </>
                    )}
                  </div>
                  <div className="mt-3 max-h-48 overflow-auto rounded-xl border bg-slate-50 p-2 text-xs">
                    {simLogs.map((l,i)=> (<div key={i} className="py-0.5"><span className="text-slate-400">[{l.t}]</span> {l.m}</div>))}
                  </div>
                </div>
              </div>

              {/* RUN PANEL (Form renderer) */}
              {tab==="run" && (
                <div className="mt-6 p-4 rounded-2xl border bg-white">
                  <div className="font-medium">Run – Form</div>
                  {!firstForm ? (
                    <div className="text-sm text-slate-500 mt-1">Template ini tidak memiliki step Form pertama.</div>
                  ) : (
                    <form className="mt-3 grid gap-3" onSubmit={submitRunForm}>
                      {(firstForm.config?.fields||[]).map((f,idx)=>(
                        <label key={idx} className="text-xs text-slate-600">
                          {f.name}
                          <input
                            type={f.type||'text'}
                            required={!!f.required}
                            className="mt-1 w-full px-3 py-2 rounded-xl border bg-white"
                            value={runData[f.name]||''}
                            onChange={(e)=>setRunData({...runData, [f.name]: e.target.value})}
                          />
                        </label>
                      ))}
                      <button className="px-3 py-2 rounded-xl bg-slate-900 text-white" type="submit">Submit & Jalankan</button>
                    </form>
                  )}
                  <div className="mt-3 text-xs max-h-40 overflow-auto rounded-xl border bg-slate-50 p-2">
                    {runLog.map((l,i)=> <div key={i}>{l}</div>)}
                  </div>
                </div>
              )}
            </aside>

            {/* RIGHT: Builder/Canvas || Preview */}
            <main className="col-span-12 lg:col-span-9">
              {tab==="builder" && (
                <>
                  <section onDrop={(e) => onDropCanvas(e)} onDragOver={(e)=>{e.preventDefault();}}
                           className="p-4 rounded-3xl border-2 border-dashed bg-white min-h-[240px]"
                           title="Tarik blok dari kiri ke area ini">
                    {steps.length === 0 && (<EmptyHint />)}
                    <div className="space-y-3">
                      {steps.map((s, i) => (
                        <div key={s.id} draggable
                             onDragStart={(e) => onDragStartStep(e, s.id)}
                             onDragOver={(e)=>e.preventDefault()}
                             onDrop={(e) => onDropCanvas(e, i)}
                             onClick={() => setSelectedId(s.id)}
                             className={`p-4 rounded-2xl border cursor-grab active:cursor-grabbing ${selectedId === s.id ? 'ring-2 ring-slate-900 border-slate-900' : 'bg-slate-50'}`}>
                          <div className="flex items-start gap-3">
                            <div className="text-xl leading-none">{iconFor(s.type)}</div>
                            <div className="grow">
                              <div className="flex items-center gap-2">
                                <input className="font-medium bg-transparent outline-none"
                                       value={s.title}
                                       onChange={(e) => updateStep(s.id, { title: e.target.value })} />
                                <span className="text-xs px-2 py-0.5 rounded-full border bg-white text-slate-600">{s.type}</span>
                                {s.label && <span className="text-[10px] px-1.5 py-0.5 rounded border bg-white text-slate-500">label: {s.label}</span>}
                              </div>
                              <div className="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2">
                                <LabeledInput label="Assignee/Role" value={s.assignee} onChange={(v) => updateStep(s.id, { assignee: v })} placeholder="ops, admin, supervisor" />
                                <LabeledNumber label="SLA (jam)" value={s.slaHours || 0} onChange={(v) => updateStep(s.id, { slaHours: v })} />
                                <ConfigBadge type={s.type} />
                              </div>
                              <ConfigEditor step={s} onChange={(cfg) => updateStep(s.id, { config: cfg })} />
                            </div>
                            <button onClick={() => removeStep(s.id)} className="text-slate-500 hover:text-red-600">✕</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </section>

                  {/* JSON Preview */}
                  <section className="mt-6 p-4 rounded-3xl border bg-white">
                    <div className="flex items-center justify-between">
                      <div className="font-medium">Spesifikasi JSON (pratinjau)</div>
                      <small className="text-slate-500">Format yang sama bisa dipakai lintas industri</small>
                    </div>
                    <pre className="mt-3 text-xs overflow-auto bg-slate-50 p-3 rounded-xl border">{JSON.stringify(asSpec(), null, 2)}</pre>
                  </section>
                </>
              )}

              {tab==="preview" && (
                <section className="p-4 rounded-3xl border bg-white">
                  <div className="flex flex-col md:flex-row gap-6">
                    <div className="md:w-1/2">
                      <div className="font-medium">Ringkasan Template</div>
                      <ul className="mt-2 text-sm text-slate-700 space-y-1">
                        {Object.entries(preview.count).map(([k,v])=>(
                          v>0 && <li key={k}>{iconFor(k)} <span className="font-medium">{k}</span>: {v}</li>
                        ))}
                      </ul>

                      <div className="mt-4">
                        <div className="text-sm font-medium">Urutan Langkah</div>
                        <ol className="mt-1 text-sm text-slate-700 list-decimal pl-5 space-y-1">
                          {preview.nodes.map(n=>(
                            <li key={n.idx}>
                              <span className="font-medium">{n.title}</span> <span className="text-slate-500">({n.type}{n.label?`, label: ${n.label}`:''})</span>
                            </li>
                          ))}
                        </ol>
                      </div>
                    </div>

                    <div className="md:w-1/2">
                      <div className="font-medium">Diagram Mini</div>
                      <MiniDiagram nodes={preview.nodes} />
                      <div className="mt-3 text-xs text-slate-500">
                        Garis utama mengikuti urutan, node <b>Router</b> menandai cabang ke node berlabel yang cocok.
                      </div>
                    </div>
                  </div>
                </section>
              )}
            </main>
          </div>

          <footer className="text-center text-xs text-slate-500 py-8">© 2025 NafsFlow – Flow Builder</footer>

          {/* SETTINGS MODAL */}
          {settingsOpen && (
            <div className="fixed inset-0 bg-black/40 grid place-items-center p-4" onClick={(e)=>{ if(e.target===e.currentTarget) setSettingsOpen(false); }}>
              <div className="w-full max-w-xl bg-white rounded-2xl p-4 border">
                <div className="flex items-center justify-between">
                  <div className="font-medium">Settings Integrasi (opsional)</div>
                  <button className="text-slate-500" onClick={()=>setSettingsOpen(false)}>✕</button>
                </div>
                <div className="grid md:grid-cols-2 gap-3 mt-3">
                  <LabeledInput label="EmailJS Service ID" value={cfg.emailjsService} onChange={v=>setCfg({...cfg, emailjsService:v})} />
                  <LabeledInput label="EmailJS Template ID" value={cfg.emailjsTemplate} onChange={v=>setCfg({...cfg, emailjsTemplate:v})} />
                  <LabeledInput label="EmailJS Public Key" value={cfg.emailjsPublicKey} onChange={v=>setCfg({...cfg, emailjsPublicKey:v})} />
                  <LabeledInput label="Google Sheets Webhook URL" value={cfg.sheetsWebhook} onChange={v=>setCfg({...cfg, sheetsWebhook:v})} />
                  <LabeledInput label="Nomor WhatsApp Tujuan" value={cfg.whatsappNumber} onChange={v=>setCfg({...cfg, whatsappNumber:v})} />
                </div>
                <div className="mt-3 text-xs text-slate-500">
                  Kosongkan saja jika belum punya; sistem akan jalan sebagai simulasi.
                </div>
                <div className="mt-3 text-right">
                  <button className="px-3 py-2 rounded-xl border" onClick={()=>setSettingsOpen(false)}>Simpan</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Subcomponents & helpers
    function slugify(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)+/g,''); }
    function now(){ const d=new Date(); return d.toLocaleTimeString(); }
    function iconFor(t){ return t==='Form'?'📝':t==='Task'?'✅':t==='Approval'?'🛂':t==='AutoAction'?'⚙️':t==='Wait'?'⏳':t==='Router'?'🔀':'🔔'; }

    function LabeledInput({ label, value, onChange, placeholder }) {
      return (
        <label className="text-xs text-slate-600">{label}
          <input className="mt-1 w-full px-3 py-2 rounded-xl border bg-white" value={value||''} placeholder={placeholder} onChange={(e)=>onChange(e.target.value)} />
        </label>
      );
    }
    function LabeledNumber({ label, value, onChange }) {
      return (
        <label className="text-xs text-slate-600">{label}
          <input type="number" className="mt-1 w-full px-3 py-2 rounded-xl border bg-white" value={value||0} min={0} onChange={(e)=>onChange(Number(e.target.value))} />
        </label>
      );
    }
    function ConfigBadge({ type }){
      const text = type==='AutoAction'?'Webhook/API': type==='Router'?'IF/ELSE': type==='Wait'?'Timer': type==='Notify'?'Messaging':'General';
      return <div className="text-xs px-2 py-2 rounded-xl border bg-white text-slate-600">{text}</div>;
    }

    function ConfigEditor({ step, onChange }){
      const { type, config = {} } = step;

      if (type === 'Form') return (
        <div className="mt-3">
          <div className="text-xs text-slate-500">Field Form</div>
          {(config.fields || []).map((f, idx) => (
            <div key={idx} className="mt-2 grid grid-cols-3 gap-2">
              <LabeledInput label="Nama" value={f.name} onChange={(v)=>updateField(idx,{...f,name:v})} />
              <LabeledInput label="Tipe" value={f.type} onChange={(v)=>updateField(idx,{...f,type:v})} />
              <label className="text-xs text-slate-600 flex items-end"><input type="checkbox" className="mr-2" checked={!!f.required} onChange={(e)=>updateField(idx,{...f,required:e.target.checked})} /> Wajib</label>
            </div>
          ))}
          <div className="mt-2 flex gap-2">
            <button className="px-3 py-2 rounded-xl border" onClick={()=>onChange({ ...config, fields: [...(config.fields||[]), { name: "field_baru", type: "text", required: false }] })}>Tambah Field</button>
            <button className="px-3 py-2 rounded-xl border" onClick={()=>onChange({ ...config, fields: [] })}>Reset</button>
          </div>
        </div>
      );

      if (type === 'AutoAction') return (
        <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
          <LabeledInput label="URL" value={config.url||''} onChange={(v)=>onChange({ ...config, url: v })} />
          <LabeledInput label="Method" value={config.method||'POST'} onChange={(v)=>onChange({ ...config, method: v })} />
          <LabeledInput label="Action" value={config.action||'webhook'} onChange={(v)=>onChange({ ...config, action: v })} />
        </div>
      );

      if (type === 'Wait') return (
        <div className="mt-3 grid grid-cols-2 gap-2">
          <LabeledNumber label="Durasi" value={config.duration||0} onChange={(v)=>onChange({ ...config, duration: v })} />
          <LabeledInput label="Unit" value={config.unit||'hours'} onChange={(v)=>onChange({ ...config, unit: v })} />
        </div>
      );

      if (type === 'Router') return (
        <div className="mt-3">
          <div className="text-xs text-slate-500">Aturan Cabang</div>
          {(config.rules||[]).map((r, idx) => (
            <div key={idx} className="mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
              <LabeledInput label="IF" value={r.if} onChange={(v)=>updateRule(idx,{...r,if:v})} />
              <LabeledInput label="GoTo (label)" value={r.goTo} onChange={(v)=>updateRule(idx,{...r,goTo:v})} />
              <button className="self-end px-3 py-2 rounded-xl border" onClick={()=>removeRule(idx)}>Hapus</button>
            </div>
          ))}
          <button className="mt-2 px-3 py-2 rounded-xl border" onClick={()=>onChange({ ...config, rules: [...(config.rules||[]), { if: "", goTo: "" }] })}>Tambah Rule</button>
        </div>
      );

      if (type === 'Notify') return (
        <div className="mt-3 grid grid-cols-2 gap-2">
          <LabeledInput label="Channel" value={config.channel||'email'} onChange={(v)=>onChange({ ...config, channel: v })} />
          <LabeledInput label="Template" value={config.template||''} onChange={(v)=>onChange({ ...config, template: v })} />
        </div>
      );

      if (type === 'Task') return (
        <div className="mt-3">
          <div className="text-xs text-slate-500">Checklist</div>
          {(config.checklist||[]).map((c, idx) => (
            <div key={idx} className="mt-2 grid grid-cols-5 gap-2">
              <div className="col-span-4"><LabeledInput label={`Item ${idx+1}`} value={c} onChange={(v)=>updateChecklist(idx, v)} /></div>
              <button className="self-end px-3 py-2 rounded-xl border" onClick={()=>removeChecklist(idx)}>Hapus</button>
            </div>
          ))}
          <button className="mt-2 px-3 py-2 rounded-xl border" onClick={()=>onChange({ ...config, checklist: [...(config.checklist||[]), "Item baru"] })}>Tambah Item</button>
        </div>
      );

      if (type === 'Approval') return (
        <div className="mt-3">
          <div className="text-xs text-slate-500">Peran pemberi persetujuan</div>
          <div className="grid grid-cols-5 gap-2">
            <div className="col-span-4"><LabeledInput label="Roles (comma-separated)" value={(config.roles||[]).join(', ')} onChange={(v)=>onChange({ ...config, roles: v.split(',').map(s=>s.trim()).filter(Boolean) })} /></div>
            <LabeledNumber label="Minimal Approver" value={config.threshold||1} onChange={(v)=>onChange({ ...config, threshold: v })} />
          </div>
        </div>
      );

      return null;

      // scoped helpers
      function updateField(idx, next){ const fields=[...(config.fields||[])]; fields[idx]=next; onChange({ ...config, fields }); }
      function updateRule(idx, next){ const rules=[...(config.rules||[])]; rules[idx]=next; onChange({ ...config, rules }); }
      function removeRule(idx){ const rules=[...(config.rules||[])]; rules.splice(idx,1); onChange({ ...config, rules }); }
      function updateChecklist(idx, val){ const list=[...(config.checklist||[])]; list[idx]=val; onChange({ ...config, checklist:list }); }
      function removeChecklist(idx){ const list=[...(config.checklist||[])]; list.splice(idx,1); onChange({ ...config, checklist:list }); }
    }

    function EmptyHint(){
      return (
        <div className="grid place-items-center py-10 text-center text-slate-500">
          <div>
            <div className="text-4xl">🧩</div>
            <div className="mt-2 font-medium">Pilih template di atas lalu klik <span className="font-semibold">Load Template</span></div>
            <div className="text-sm">Atau tarik blok dari kiri untuk menyusun alur sendiri.</div>
          </div>
        </div>
      );
    }

    function MiniDiagram({ nodes }){
      // Simple linear SVG + badges Router
      const h = 120, w = 520, stepW = 90, gap = 30;
      const totalW = Math.min(w, nodes.length*(stepW+gap)+40);
      return (
        <svg viewBox={`0 0 ${totalW} ${h}`} className="mt-2 w-full border rounded-xl">
          {/* line */}
          <line x1="20" y1={h/2} x2={totalW-20} y2={h/2} stroke="#cbd5e1" strokeWidth="2"/>
          {nodes.map((n,i)=>{
            const x = 40 + i*(stepW+gap);
            const y = h/2 - 18;
            const isRouter = n.type === "Router";
            return (
              <g key={i} transform={`translate(${x},${y})`}>
                <rect rx="8" ry="8" width="80" height="36" fill={isRouter?"#fef3c7":"#f1f5f9"} stroke="#cbd5e1"/>
                <text x="40" y="22" textAnchor="middle" fontSize="10" fill="#334155">{n.type}</text>
                {isRouter && <text x="40" y="-6" textAnchor="middle" fontSize="9" fill="#b45309">Router</text>}
              </g>
            );
          })}
        </svg>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<NafsFlowBuilder />);
  </script>
</body>
</html>
