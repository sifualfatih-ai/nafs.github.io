<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Invoice Generator (Offline & Online)</title>
<style>
  :root{
    --bg:#11071e;--card:#1f1438;--line:#2d2050;--text:#efeaff;--muted:#c7b7f0;--accent:#7c3aed;
    --panel:#15102a; --radius:14px;
  }
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;
       background:radial-gradient(900px 500px at 50% -10%, rgba(124,58,237,.18), transparent 60%), var(--bg);
       color:var(--text); padding:22px}
  .wrap{width:min(980px,94vw);margin:0 auto}
  h1{margin:0 0 12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:16px}
  label{font-size:13px;color:var(--muted)}
  input,textarea,select{width:100%;padding:12px;border:1px solid var(--line);background:var(--panel);color:var(--text);border-radius:10px;margin-top:6px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;margin-top:8px}
  th,td{border:1px solid var(--line);padding:10px;background:#120c27}
  th{background:#1b1233}
  td:first-child,th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  td:last-child,th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  .btn{background:#2a1f4a;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .btn:hover{background:#3a2b69}
  .accent{background:var(--accent);border:none}
  .right{text-align:right}
  .noprint-only{display:inline-block}
  .status{font-size:13px;color:#c7b7f0;margin-left:10px}
  footer{margin-top:18px;text-align:center;color:#c7b7f099}
  @media print{
    body{background:#fff;color:#000}
    .noprint-only{display:none}
    .card{border-color:#ccc}
    input,textarea{border:1px solid #ccc;background:#fff;color:#000}
    th,td{background:#fff;border-color:#ccc}
    footer{color:#666}
  }
  .inv-header{display:flex;justify-content:space-between;align-items:flex-start;gap:14px}
  .brand-box{min-width:180px;background:#1b1233;border:1px solid var(--line);border-radius:10px;padding:12px 14px}
  .brand-title{margin:0;font-weight:700;font-size:18px}
  .inv-meta{text-align:right}
  .badge{display:inline-block;background:#7c3aed22;border:1px solid #7c3aed44;color:var(--text);
         font-weight:700;padding:4px 8px;border-radius:999px;margin-bottom:6px}

  /* ===== Gate Private ===== */
  .hidden{display:none}
  .gate{
    position:fixed; inset:0; display:grid; place-items:center; padding:24px;
    background:linear-gradient(180deg, rgba(6,5,12,.9), rgba(6,5,12,.96));
    backdrop-filter: blur(2px); z-index:9999;
  }
  .gate-card{width:min(460px,94vw); background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px}
  .muted{color:var(--muted)}
  .topbar{
    display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px;
  }
  .pill{
    display:inline-block; padding:6px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; color:var(--muted);
  }
</style>
</head>
<body>

<!-- ===== GATE (LOCK SCREEN) ===== -->
<section id="gate" class="gate">
  <div class="gate-card">
    <h2 style="margin:0 0 6px">Akses Admin</h2>
    <p class="muted" style="margin:0 0 12px">Halaman ini <b>private</b>. Masukkan email admin yang diizinkan untuk melanjutkan. <br>Jika belum terdaftar, hubungi admin Nafs untuk mendapatkan akses.</p>
    <label>Email admin</label>
    <input id="gateEmail" placeholder="email@gmail.com" autocomplete="email" style="width:100%; margin:6px 0 10px">
    <div style="display:flex; gap:8px; align-items:center">
      <button id="btnGateLogin" class="btn accent">Login</button>
      <span id="gateStatus" class="status"></span>
    </div>
  </div>
</section>

<!-- ===== TOPBAR (tampil saat login) ===== -->
<div class="wrap hidden" id="topbar">
  <div class="topbar noprint-only">
    <span class="pill">Privat • Hanya admin</span>
    <div style="display:flex; gap:8px; align-items:center">
      <span id="who" class="muted"></span>
      <button id="btnLogout" class="btn">Keluar</button>
    </div>
  </div>
</div>

<div class="wrap hidden" id="app"><!-- app disembunyikan sampai login -->
  <h1 class="noprint-only">Invoice Generator — <span style="color:#a78bfa">Bot Invoice Nafs</span></h1>

  <!-- FORM INPUT -->
  <section class="card noprint-only">
    <div class="grid">
      <div>
        <label>Nomor Invoice</label>
        <input id="invNo" placeholder="INV-2025-001">
      </div>
      <div>
        <label>Tanggal</label>
        <input id="invDate" type="date">
      </div>
      <div>
        <label>Nama Usaha / Pengirim</label>
        <input id="fromName" placeholder="Nafs Project" value="Nafs Project">
      </div>
      <div>
        <label>Untuk / Penerima</label>
        <input id="toName" placeholder="Nama Pelanggan">
      </div>
    </div>

    <div style="margin-top:14px">
      <table id="itemsTbl">
        <thead>
          <tr><th>Deskripsi</th><th style="width:120px">Qty</th><th style="width:160px">Harga (Rp)</th><th style="width:160px">Subtotal (Rp)</th><th class="noprint-only" style="width:60px">Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <button type="button" class="btn noprint-only" id="btnAdd">+ Tambah Item</button>
    </div>

    <div class="grid" style="margin-top:14px">
      <div>
        <label>Catatan (opsional)</label>
        <textarea id="notes" placeholder="Terima kasih telah bertransaksi."></textarea>
      </div>
      <div class="card" style="background:#15102a">
        <div class="grid" style="gap:12px">
          <div><label>Diskon (Rp)</label><input id="disc" type="number" value="0" min="0"></div>
          <div><label>PPN (%)</label><input id="tax" type="number" value="0" min="0"></div>
        </div>
        <div style="margin-top:10px">
          <div class="right">Subtotal: <b id="subTotal">0</b></div>
          <div class="right">Diskon: <b id="discShow">0</b></div>
          <div class="right">PPN: <b id="taxShow">0</b></div>
          <div class="right" style="font-size:20px;margin-top:6px">Total: <b id="grandTotal">0</b></div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
      <button class="btn" id="btnPreview">Terapkan ke Invoice</button>
      <button class="btn accent" id="btnPrint">Cetak / Simpan PDF</button>
      <button class="btn" id="btnSaveOnline">Simpan Online (Spreadsheet)</button>
      <span id="saveStatus" class="status"></span>
    </div>
  </section>

  <!-- PRATINJAU INVOICE -->
  <section class="card" id="preview">
    <div class="inv-header">
      <!-- Brand kiri -->
      <div class="brand-box">
        <p class="brand-title">Nafs Project</p>
        <small style="color:#c7b7f0">UMKM • Digital Service</small>
      </div>
      <!-- Title + meta kanan -->
      <div class="inv-meta">
        <div class="badge">INVOICE</div>
        <div>No: <span id="pNo">—</span></div>
        <div>Tgl: <span id="pDate">—</span></div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;gap:14px;margin-top:10px">
      <div><b>Dari:</b> <span id="pFrom">—</span></div>
      <div style="text-align:right"><b>Kepada:</b> <span id="pTo">—</span></div>
    </div>

    <table style="margin-top:12px">
      <thead><tr><th>Deskripsi</th><th class="right">Qty</th><th class="right">Harga</th><th class="right">Subtotal</th></tr></thead>
      <tbody id="pItems"></tbody>
      <tfoot>
        <tr><td colspan="3" class="right"><b>Subtotal</b></td><td class="right" id="pSub">0</td></tr>
        <tr><td colspan="3" class="right">Diskon</td><td class="right" id="pDisc">0</td></tr>
        <tr><td colspan="3" class="right">PPN</td><td class="right" id="pTax">0</td></tr>
        <tr><td colspan="3" class="right"><b>Total</b></td><td class="right" id="pGrand">0</td></tr>
      </tfoot>
    </table>

    <div style="margin-top:12px"><b>Catatan:</b><br><span id="pNotes">—</span></div>
  </section>

  <footer>© Nafs Project 2025</footer>
</div>

<script>
  // ====== Allowlist admin email ======
  const ALLOWED_EMAILS = [
    "nazrentalmotor@gmail.com",   // <— ganti/ tambah email admin di sini
    // "email-lain@domain.com",
  ];
  const STORAGE_KEY = "nafs_invoice_admin_email";

  // ===== util & konfigurasi =====
  const rupiah = n => (Number(n)||0).toLocaleString('id-ID');
  const SHEET_WEBAPP_URL = 'PASTE_WEB_APP_URL_DI_SINI'; // ganti setelah membuat Apps Script Web App

  // ====== Gate helpers ======
  function isAllowed(email){
    if(!email) return false;
    const e = email.trim().toLowerCase();
    return ALLOWED_EMAILS.map(x=>x.toLowerCase()).includes(e);
  }
  function currentEmail(){
    return (localStorage.getItem(STORAGE_KEY)||"").toLowerCase();
  }
  function setEmailSession(email){
    if(email) localStorage.setItem(STORAGE_KEY, email.toLowerCase());
  }
  function clearSession(){
    localStorage.removeItem(STORAGE_KEY);
  }
  function renderGate(){
    const gate   = document.getElementById('gate');
    const app    = document.getElementById('app');
    const topbar = document.getElementById('topbar');
    const who    = document.getElementById('who');

    const email = currentEmail();
    const ok = isAllowed(email);

    if(ok){
      gate.classList.add('hidden');
      app.classList.remove('hidden');
      topbar.classList.remove('hidden');
      who.textContent = email;
    }else{
      gate.classList.remove('hidden');
      app.classList.add('hidden');
      topbar.classList.add('hidden');
      who.textContent = '';
    }
  }

  // ====== App utama ======
  document.addEventListener('DOMContentLoaded', () => {
    // Gate actions
    document.getElementById('btnGateLogin').addEventListener('click', ()=>{
      const input = document.getElementById('gateEmail');
      const status = document.getElementById('gateStatus');
      const email = (input.value||'').trim().toLowerCase();
      if(!email){ status.textContent = 'Masukkan email.'; return; }
      if(!isAllowed(email)){ status.textContent = 'Email tidak diizinkan. Hubungi admin.'; return; }
      setEmailSession(email);
      status.textContent = 'Berhasil. Membuka halaman...';
      renderGate();
    });
    document.getElementById('btnLogout').addEventListener('click', ()=>{
      clearSession();
      renderGate();
    });

    renderGate(); // cek sesi saat pertama

    // ====== Jika belum login, cegah aksi tombol penting ======
    function guard(){ if(!isAllowed(currentEmail())){ alert('Halaman privat. Silakan login admin.'); return false; } return true; }

    // ==== Fitur invoice (hanya binding saat DOM ready; guard dijalankan di handler) ====
    const tbody = document.querySelector('#itemsTbl tbody');

    function addRow(desc = '', qty = 1, price = 0) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="i-desc" placeholder="Deskripsi" value="${desc}"></td>
        <td><input class="i-qty" type="number" min="0" value="${qty}"></td>
        <td><input class="i-price" type="number" min="0" value="${price}"></td>
        <td class="right i-sub">0</td>
        <td class="noprint-only">
          <button type="button" class="btn btn-sm btn-remove">✕</button>
        </td>`;
      tbody.appendChild(tr);
      calc();
    }

    tbody.addEventListener('click', (e) => {
      if(!guard()) return;
      const btn = e.target.closest('.btn-remove');
      if (btn) {
        btn.closest('tr')?.remove();
        calc();
      }
    });

    tbody.addEventListener('input', (e) => {
      if(!guard()) return;
      if (e.target.matches('.i-desc, .i-qty, .i-price')) calc();
    });

    document.getElementById('btnAdd').addEventListener('click', (e) => {
      e.preventDefault();
      if(!guard()) return;
      addRow();
    });

    // baris awal (tidak bikin data sensitif)
    addRow('Layanan/Jasa', 1, 100000);

    window.calc = function calc() {
      let sub = 0;
      [...tbody.querySelectorAll('tr')].forEach(tr => {
        const q = Number(tr.querySelector('.i-qty').value) || 0;
        const p = Number(tr.querySelector('.i-price').value) || 0;
        const st = q * p;
        tr.querySelector('.i-sub').textContent = rupiah(st);
        sub += st;
      });
      const disc = Number(document.getElementById('disc').value) || 0;
      const taxPct = Number(document.getElementById('tax').value) || 0;
      const afterDisc = Math.max(sub - disc, 0);
      const tax = Math.round(afterDisc * taxPct / 100);
      const grand = afterDisc + tax;

      document.getElementById('subTotal').textContent = rupiah(sub);
      document.getElementById('discShow').textContent = rupiah(disc);
      document.getElementById('taxShow').textContent  = rupiah(tax);
      document.getElementById('grandTotal').textContent = rupiah(grand);
      return { sub, disc, tax, grand };
    };

    document.getElementById('btnPreview').addEventListener('click', () => {
      if(!guard()) return;
      const {sub,disc,tax,grand} = calc();
      document.getElementById('pNo').textContent   = document.getElementById('invNo').value || '—';
      document.getElementById('pDate').textContent = document.getElementById('invDate').value || '—';
      document.getElementById('pFrom').textContent = document.getElementById('fromName').value || '—';
      document.getElementById('pTo').textContent   = document.getElementById('toName').value || '—';
      document.getElementById('pNotes').textContent= document.getElementById('notes').value || '—';

      const pBody = document.getElementById('pItems');
      pBody.innerHTML = '';
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const d = tr.querySelector('.i-desc').value;
        const q = Number(tr.querySelector('.i-qty').value)||0;
        const p = Number(tr.querySelector('.i-price').value)||0;
        const st = q*p;
        const row = document.createElement('tr');
        row.innerHTML = `<td>${d||'-'}</td><td class="right">${q}</td><td class="right">${rupiah(p)}</td><td class="right">${rupiah(st)}</td>`;
        pBody.appendChild(row);
      });

      document.getElementById('pSub').textContent   = rupiah(sub);
      document.getElementById('pDisc').textContent  = rupiah(disc);
      document.getElementById('pTax').textContent   = rupiah(tax);
      document.getElementById('pGrand').textContent = rupiah(grand);
    });

    document.getElementById('btnPrint').addEventListener('click', () => {
      if(!guard()) return;
      document.getElementById('btnPreview').click();
      window.print();
    });

    document.getElementById('btnSaveOnline').addEventListener('click', async () => {
      if(!guard()) return;
      const status = document.getElementById('saveStatus');
      status.textContent = 'Menyimpan...';
      document.getElementById('btnPreview').click();

      const items = [...tbody.querySelectorAll('tr')].map(tr=>({
        desc: tr.querySelector('.i-desc').value,
        qty : Number(tr.querySelector('.i-qty').value)||0,
        price: Number(tr.querySelector('.i-price').value)||0
      }));

      const payload = {
        no:  document.getElementById('invNo').value,
        date:document.getElementById('invDate').value,
        from:document.getElementById('fromName').value,
        to:  document.getElementById('toName').value,
        notes:document.getElementById('notes').value,
        items,
        summary: calc()
      };

      if (!SHEET_WEBAPP_URL || SHEET_WEBAPP_URL.startsWith('PASTE_')) {
        status.textContent = '❗ Set Web App URL dulu (Apps Script).';
        return;
      }

      try{
        const res = await fetch(SHEET_WEBAPP_URL, {
          method:'POST',
          mode:'cors',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        status.textContent = data?.message || 'Tersimpan ✅';
      }catch(err){
        console.error(err);
        status.textContent = 'Gagal menyimpan (cek koneksi / URL web app).';
      }
    });
  });
</script>
</body>
</html>
